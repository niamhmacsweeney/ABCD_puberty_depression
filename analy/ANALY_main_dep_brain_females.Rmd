---
title: "ANALY_main_dep_brain_females"
author: "Niamh MacSweeney" Credit to X. Shen for function templates.
date: "12/09/2022"
output: github_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

ABCD Main Analysis Script - Depression ~ Pubertal timing -> Females

#Introduction

FILL IN LATER

Required Input: data_main_analy.rds

Cleaned data Rds files are located in /Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/data


------------------------------------------------------------------------

####Workflow

1.  Setup: Load data, merge to create master dataframe.
2.  Set up  function
3.  Run models

####STEP 1: SETUP Load libraries and set wd

```{r, load libraries, set wd}


library(tidyverse)
library(lme4)
library(lmerTest)
library(nlme)
library(psych)
library(ggplot2)
library(readr)
library(pbapply)
library(gridExtra)
library(sandwich)
library(stringr)
library(kableExtra)
#library(epiDisplay)
library(gmodels)
library(caret)


setwd("/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/analy")
```

Load data:

Note, data has already been split by sex so this dataframe is for females only

```{r,load data}

#clean data N= 4960
df <-rio::import("/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/data/data_main_analy.rds")


```

#test - run within script (i.e. not using function)

```{r, run model}
basic_mod <- lmerTest::lmer(cbcl_withdep_y3 ~ pt_f + age_years + race_y0 
                            + (1|site_id) + (1|rel_family_id),
                               na.action = na.omit,
                               REML = TRUE,
                               data = df)

summary(basic_mod, correlation = FALSE)

full_mod <- lmerTest::lmer(cbcl_withdep_y3 ~ pt_f + age_years + race_y0 + household_income_y0 
                           + parent_dep_y0 + acs_raked_propensity_score_y0
                            + (1|site_id) + (1|rel_family_id),
                               na.action = na.omit,
                               REML = TRUE,
                               data = df)
summary(full_mod, correlation = FALSE)
```


```{r, show in table}


sjPlot::tab_model(basic_mod, full_mod,
                  show.se = TRUE,
                  show.df = FALSE,
                  show.ci = FALSE,
                  digits = 3,
                  pred.labels = c("Pubertal timing"),
                  dv.labels = c("basic", "full"),
                  string.se = "SE",
                  string.p = "P-Value")

```



Note: name of object needs to be targetdata for function

```{r, generate subsample, get females only}

targetdata <- df

```

####STEP 3: Model set up We are using X.Shen's reg_phewasStyle_Random.R function to run the mixed effects models for both unilateral and bilateral brain regions. Note that we will use an average measure across the left and right hemispheres for bilateral brain regions. 

We need to change "src_subject_id" to "f.eid" so that function will run.

```{r, colnames}
colnames(targetdata)[1]='f.eid'
colnames(targetdata) #check it worked

#check for duplicate columns
unique_names <- unique(colnames(targetdata)) #no duplicates 

```

Define Basic Model 

IV: pubertal timing year 1

DV: Depression year 3

Covariates: Fixed = age, race/ethnicity; 

Random: family ID, site ID.

Notes on function:

- Make sure that the "family" argument in function is correct (i.e., we want it to be "poisson" not "binomial")

Define function 

```{r, Phewas function}

source('../functions/reg_phewasStyle_Random.R')

```

Define global variables

```{r, global vars}
targetdata=targetdata

```

Set up dependent variable: cbcl_withdep_y3

```{r, set up DVs}
#select vars of interest

ls.dep.fs.short=colnames(targetdata)[grep('cbcl_withdep_y3',colnames(targetdata))]
ls.dep.all = ls.dep.fs.short
ls.dep.all=ls.dep.all[!duplicated(ls.dep.all)]

```

Set up Independent Variable (or factor): Pubertal timing 

```{r, set up IVs}

ls.factor=colnames(targetdata)[grep('pt_f',
                                    colnames(targetdata))]

```

Combine DVs and IVs so that we get a list of the DV and IV

```{r, combine DVs and IVs}

ls.dep.factor.combo=expand.grid(ls.dep.all,ls.factor,stringsAsFactors = F)

```

Set up Covariates Note: We are adding hemisphere as a covariate here...

```{r, set up covs}

ls.models=data.frame(dependent=ls.dep.factor.combo$Var1,
                     factor=ls.dep.factor.combo$Var2,
                     covs='',stringsAsFactors = F)

ls.models$covs=paste0(c('age_years','race_y0', 'bmi_y1', 'household_income_y0', "parent_dep_y0", "acs_raked_propensity_score_y0"),collapse='+') #just list fixed covariates here. Random effects:'site_id', rel_family_id are specified in function

```

#### STEP 4: Specify models

USER: Make sure that the model names specified below match the model names defined in function. 

```{r, specify models}

ls.models$model.est=''
ls.models$model.est[grep('hemi',ls.models$covs)]='bilateral' #we are defining here for purposes of function but we are not using the bilateral elements as we have used an average measure - therefore, the model will use lme models for all other cases. 
ls.models$model.est[ls.models$model.est=='']='lme'


```

Rename models to match function

```{r, main model}
ls.model.bulk=ls.models
ls.model.bulk$p_batch=1

```

#### STEP 5: Run Model

```{r, run model}

result.females.pt.dep_full=reg_phewasStyle(ls.model.bulk,dat_short=targetdata,dat_long=dat_long,correctByFactor = T)

summary(result.females.pt.dep)

#Save as R.Data file
save(result.females.pt.dep,file='../results/main_analysis/females_pt_dep_full_mod.RData')

#add TRUE column if nominal p value < 0.006 for pilot ROIs, which means that all values of ≤0.005... will be included due to the large number of decimal places. 

#global results
result.females.dep_brain.bulk$Sig <- as.numeric((as.character(result.females.dep_brain.bulk[,"p.value"]))) < 0.006

#regional results
result.females.dep_brain.region.covWholeB$Sig <- as.numeric((as.character(result.females.dep_brain.region.covWholeB[,"p.value"]))) < 0.006

#Save results as .csv files

#global results
write.csv(result.females.dep_brain.bulk, file = '../results/revised_pilot/tables/supplementary_data/pilot_females.dep_brain.bulk.csv')

#regional results 
write.csv(result.females.dep_brain.region.covWholeB, file = '../results/revised_pilot/tables/supplementary_data/pilot_females_dep_brain.regional.csv')

```

###STEP 6: Identify ROIs for confirmatory analysis. Threshold: Nominal p-value ≤ 0.005

Note: The threshold is indicated as <0.006 to account for the large number of decimal places given for p-values. 

```{r, make tables}

#save regional ROIs
ROI_dep_brain_females_regional_results <- result.females.dep_brain.region.covWholeB %>%
  filter(p.value < 0.006)

ROI_dep_brain_females_global_results <- result.females.dep_brain.bulk %>% 
    filter(p.value < 0.006)


#save as R.data
save(ROI_dep_brain_females_regional_results, ROI_dep_brain_females_global_results, file='../results/revised_pilot/ROIs_dep_brain_females.RData')

#save as .csv
#regional
write.csv(ROI_dep_brain_females_regional_results, file = "../results/revised_pilot/tables/ROIs_dep_brain_regional_females.csv")

#global
write.csv(ROI_dep_brain_females_global_results, file = "../results/revised_pilot/tables/ROIs_dep_brain_global_females.csv")

```

 \#\#\#\#\#\#\#\#\#\#\#\#\#\# End of Script \#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#

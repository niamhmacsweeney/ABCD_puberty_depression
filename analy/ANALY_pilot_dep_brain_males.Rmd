---
title: "ANALY_pilot_dep_brain_males"
author: "Niamh MacSweeney"  Credit to X. Shen for function templates. 
date: "08/9/2021"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

\#ABCD Pilot Analysis Script - Depression ~ Brain Structure -> Males

\#Introduction

The purpose of this script is to run the pilot analysis (DR~BS) for the Puberty RR. For this analysis, we will be using a random sub-sample of 10% (N= ~1,000) to generate ROIs for the depression ~ brain structure association.

This sub-sample will be split into males and females and the script will be run independently for each.

We will be using an un-related sample of participants for our analysis. The pilot analysis will use a basic model, outlined below.

\#\#\#Required Inputs

Cleaned data Rds files are located in /Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/data

\#\#\#\#Independent Variable Depression Rating (Parent report): dep_measures_cleaned_R3.0.rds

\#\#\#\#Dependent Variable Brain structure: cortical_cleaned_R3.0.rds + subcort_cleaned_R3.O.rds + dti_cleaned_R3.0.rds

\#\#\#\#Covariates Covariates: covariates_cleaned_R3.0.rds

------------------------------------------------------------------------

####Workflow 

1. Setup: Load data, merge to create master dataframe, keep unrelated participants only 
2. Pilot prep: Get subsample of 10% of unrelated sample (N= 9,775). Split into males and females. 
3. Set up glm/lme function using Shen's template script

####STEP 1: SETUP Load libraries and set wd

```{r, load libraries, set wd}

library(tidyr)
library(dplyr)
library(tidyverse)
library(psych)
library(ggplot2)
library(readr)
library(pbapply)
library(nlme)
library(gridExtra)
library(sandwich)
library(stringr)
library(kableExtra)
library(epiDisplay)
library(gmodels)
library(plyr)

setwd("/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/analy")
```

Load data:

Note on depression variables:

- KSADS.MDD.y: MDD diagnosis based on child report
- KSADS.MDD.p: MDD diagnosis based on caregiver report
- KSADS.Dep_symptoms_sum_ever.y: no. of depressive symptoms reported based on child report
- KSADS.Dep_symptoms_sum_ever.p: no. of depressive symptoms reported based on caregiver report
- KSADS.Depressive_symptoms_ever.y: DSM-V depressive symptoms reported by children
- KSADS.Depressive_symptoms_ever.p: DSM-V depressive symptoms reported by caregivers

```{r,load data}

#Depression data 
dep <-rio::import("/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/data/dep_measures_cleaned_R3.0.rds")

#Imaging data
cortical <-rio::import("/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/data/cortical_cleaned_R3.0.rds")

subcort <-rio::import("/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/data/subcort_cleaned_R3.0.rds")

dti <- rio::import("/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/data/dti_cleaned_R3.0.rds")

#Covariates
covs <- rio::import("/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/data/covariates_cleaned_R3.0.rds")

```

Merge dataframes to create master dataframe

As we have a five data frames to merge, we are going to do it stepwise using dplyr function.

```{r, merge DFs}

df <- dep %>% 
  left_join(y=cortical, by= "src_subject_id") %>% 
  left_join(y=subcort, by= "src_subject_id") %>% 
  left_join(y=dti, by= "src_subject_id") %>% 
  left_join(y=covs, by="src_subject_id")

#check col names
colnames(df)

```

Check variable classifcation

```{r, variable classification}

covs_str <- df %>% 
  dplyr::select("sex", "bmi", "race.6level", "age_years", "abcd_site", "fsqc_qu_motion") %>% 
  str()
```

Reduce to unrelated sample only Before N=11878, After N=9,856

```{r, get unrelated sample}

unrel_df =df[!duplicated(df$rel_family_id),]
```

Get sample demographics 
```{r, sample demographics}

unrel_df %>% 
  dplyr::select(age_years, sex) %>% 
  summary()

#get sd
sd(unrel_df$age_years) #SD=0.62
#get mean
mean(unrel_df$age_years) #mean=9.90

#make df with unrelated males only for demographic table purposes
unrel_males <- unrel_df %>% #N= 4673
    filter(sex == "M")
```

####STEP 2: Generate subsample (10% of unrelated sample) for pilot analysis. N=986 Get males only

```{r, generate subsample, get males only}

set.seed(2507) #set seed for reproducibility
targetdata <- unrel_df %>% 
  sample_frac(size = 0.1, replace = FALSE)

#check males and females breakdown F= 475, M=511
targetdata %>% 
  dplyr::count(sex)

#get mean age and sd for pilot sample
mean(targetdata$age_years)
sd(targetdata$age_years)

#Get Male sample only 
targetdata <- targetdata %>% 
  filter(sex == "M")

```

Make demographics table for MDD/DS breakdown 
```{r, MDD/DS demographics table}

####TOTAL MALE UNRELATED SAMPLE

#MDD case control
CrossTable(unrel_males$KSADS.MDD.p, 
           prop.t = TRUE, prop.r = TRUE, prop.c = TRUE)

#MDD and age breakdown
ddply(unrel_males,~KSADS.MDD.p,summarise,mean=mean(age_years),sd=sd(age_years))

#DS category breakdown
CrossTable(unrel_males$KSADS.Depressive_symptoms_ever.p, 
           prop.t = TRUE, prop.r = TRUE, prop.c = TRUE)

#DS and age breakdown
ddply(unrel_males,~KSADS.Depressive_symptoms_ever.p,summarise,mean=mean(age_years),sd=sd(age_years))

#### PILOT ANALYSIS SAMPLE
#MDD case control
CrossTable(targetdata$KSADS.MDD.p, 
           prop.t = TRUE, prop.r = TRUE, prop.c = TRUE)

#MDD and age breakdown
ddply(targetdata,~KSADS.MDD.p,summarise,mean=mean(age_years),sd=sd(age_years))

#DS category breakdown
CrossTable(targetdata$KSADS.Depressive_symptoms_ever.p, 
           prop.t = TRUE, prop.r = TRUE, prop.c = TRUE)

#DS and age breakdown
ddply(targetdata,~KSADS.Depressive_symptoms_ever.p,summarise,mean=mean(age_years),sd=sd(age_years))


```
####STEP 3: Model set up We are using X.Shen's phewasStyle.R function to run the linear models.

We need to change "src_subject_id" to "f.eid" so that function will run.

```{r, colnames}
colnames(targetdata)[1]='f.eid'
colnames(targetdata) #check it worked

```

Set categorical variables

```{r, set categorical variables}

targetdata$race.6level = as.factor(targetdata$race.6level)
targetdata$sex = as.factor(targetdata$sex)
targetdata$fsqc_qu_motion = as.factor(targetdata$fsqc_qu_motion)
targetdata$abcd_site = as.factor(targetdata$abcd_site)

```

Generate long-format data.

Note: for the lme models (bilaterlal brain regions only), the data needs to be in long-format (i.e, there is a row per hemisphere (lh and rh) for each participant. This is why the number of obs/rows doubles. In other words we are using a repeated measures design that looks at lh and rh independently and then combines them to generate a single association metric. [This is a very rough explanation to help facilitate understanding]

```{r, gen long-format data}
# colnames of imaging data
dat_colnames = colnames(targetdata)[grep('lh\\.|rh\\.',colnames(targetdata))] 

# colnames of non-imaging data/unilateral img data
cols_nonimg = colnames(targetdata)[!grepl('lh\\.|rh\\.',colnames(targetdata))]  
cols_nonimg = cols_nonimg[2:length(cols_nonimg)]

source('../functions/long_format_new.R')
targetdata_longformat <- long_format(targetdata,cols_nonimg,cols_img)

```

Define functions

```{r, Phewas function}

source('../functions/reg_phewasStyle_withCI.R')

```

Define global variables

```{r, global vars}
targetdata=targetdata
dat_long=targetdata_longformat
```

Set up dependent variables (brain measures: cortical(APARC files); subcortical(ASEG files); whitematter(dti)

```{r, set up DVs}
ls.dep.fs.long=colnames(dat_long)[grep('sa\\.|thk\\.|vol\\.|sulc\\.|dtifa\\_|dtimd\\_|\\.ASEG\\.',colnames(dat_long))]
ls.dep.fs.short=colnames(targetdata)[grep('^bl\\.',colnames(targetdata))]
ls.dep.all=c(ls.dep.fs.long,ls.dep.fs.short)

ls.dep.all=ls.dep.all[c(grep('sa\\.|thk\\.|vol\\.|sulc\\.',ls.dep.all),
                        grep('\\.ASEG\\.',ls.dep.all),
                        grep('dtifa\\_',ls.dep.all),
                        grep('dtimd\\_',ls.dep.all))]
ls.dep.all=ls.dep.all[!duplicated(ls.dep.all)]

```

Set up Independent Variables (or factors) (depression measures)
Depression measures are indexed in two ways:
  1. MDD diagnosis = KSADS.MDD (1=yes, 0= no, binary)
  2. Depression symptom severity (ordinal measure:none, mild, moderate, severe (rated 0-3         respectively)) = KSADS.Depressive_symptoms_ever
  
We have also derived a continuous measure of depression symptom severity, which will not be used in current analysis but may be useful for future analysis = KSADS.Dep_symptoms_sum_ever (0-15 continuous scale). 

```{r, set up IVs}

ls.factor=colnames(targetdata)[grep('^KSADS\\.MDD\\.|^KSADS\\.Depressive_symptoms_ever',
                                    colnames(targetdata))]
ls.factor=c(ls.factor[grep('.p$',ls.factor)]) #ls.factor[grep('.y$',ls.factor)]) #we are not including youth report in current analysis. 

#^KSADS\\.Depressive_symptoms_ever = binary measure of DS. Not using in models. 

```

Combine DVs and IVs so that we get a list of the DV and IV

```{r, combine DVs and IVs}

ls.dep.factor.combo=expand.grid(ls.dep.all,ls.factor,stringsAsFactors = F)

```

Set up Covariates Note: We are adding hemisphere as a covariate here...

```{r, set up covs}

ls.models=data.frame(dependent=ls.dep.factor.combo$Var1,
                     factor=ls.dep.factor.combo$Var2,
                     covs='',stringsAsFactors = F)

ls.models$covs=paste0(c('age_years','bmi','abcd_site','race.6level','fsqc_qu_motion'),collapse='+')

ls.models$covs[!grepl('bl\\.',ls.models$dependent)]=paste0(ls.models$covs[!grepl('bl\\.',ls.models$dependent)],'+hemi')

```

#### STEP 4: Specify models

```{r, specify models}

ls.models$model.est=''
ls.models$model.est[grep('hemi',ls.models$covs)]='lme'
ls.models$model.est[ls.models$model.est=='']='glm'

```

Divide models into bulk measures and individual regions

Bulk (global) measures

```{r, bulk measures}
ls.model.bulk=ls.models[grep('mean|total|allfibers',ls.models$dependent),]
ls.model.bulk$p_batch=1
```

Individual regions

```{r, individual regions}

ls.model.region=ls.models[!grepl('mean|total|allfibers',ls.models$dependent),]

ls.model.region$p_batch=99999
target.model=ls.model.region
ls.dep.cate=c('thk\\.','sa\\.','vol\\.APARC','sulc\\.','vol\\.ASEG','dtifa\\_','dtimd\\_')
ls.factor.cate=unique(target.model$factor)
cate.no = 1
for (fac in ls.factor.cate){
      for (dep in ls.dep.cate){
            loc = grepl(dep,target.model$dependent)&grepl(fac,target.model$factor)
            target.model$p_batch[loc]=cate.no
            cate.no=cate.no+1
      }
}
ls.model.region=target.model

# individual region models add intracranial volume as a covariate
ls.model.region.covWholeB=ls.model.region
ls.model.region.covWholeB$covs[grep('thk\\.|sa\\.|vol\\.APARC|sulc\\.|vol\\.ASEG',ls.model.region.covWholeB$dependent)]=
      paste0(ls.model.region.covWholeB$covs[grep('thk\\.|sa\\.|vol\\.APARC|sulc\\.|vol\\.ASEG',ls.model.region.covWholeB$dependent)],'+ICV_ASEG')

```

#### STEP 5: Run Models

```{r, run models}

#Global (bulk) models
result.males.dep_brain.bulk=reg_phewasStyle(ls.model.bulk,dat_short=targetdata,dat_long=dat_long,correctByFactor = T)

#Regional (Individual) models
result.males.dep_brain.region.covWholeB=reg_phewasStyle(ls.model.region.covWholeB,dat_short=targetdata,dat_long=dat_long,correctByFactor = T)

#Save as R.Data file
save(result.males.dep_brain.bulk,result.males.dep_brain.region.covWholeB,file='../results/males_dep_brain_pilot_analysis_withCI.RData')

#add TRUE column if nominal p value < 0.005 for pilot ROIs

#global results
result.males.dep_brain.bulk$Sig <- as.numeric((as.character(result.males.dep_brain.bulk[,"p.value"]))) < 0.005

#regional results
result.males.dep_brain.region.covWholeB$Sig <- as.numeric((as.character(result.males.dep_brain.region.covWholeB[,"p.value"]))) < 0.005

#Save results as .csv files

#global results
write.csv(result.males.dep_brain.bulk, file = "../results/tables/pilot_analy_males.dep_brain.bulk.csv")

#regional results 
write.csv(result.males.dep_brain.region.covWholeB, file = "../results/tables/pilot_analy_males.dep_brain.regional.csv")

```

STEP 6: Identify ROIs for confirmatory analysis. Threshold: Nominal p-value =\< 0.005

```{r, make tables}


ROI_dep_brain_males_regional_results <- result.males.dep_brain.region.covWholeB %>% 
  filter(p.value <0.005) %>% 
  select(-dependent, -factor) %>% 
  #mutate(as.numeric(ROI_females_regional)) %>% 
  #mutate_if(is.numeric, ~round(., 4)) %>% 
  arrange(p.value)

str(ROI_dep_brain_males_regional_results) #check variable chars

save(ROI_dep_brain_males_regional_results,file='../results/ROIs_dep_brain_males_pilot_analysis_withCI.RData')

#save as .csv
write.csv(ROI_dep_brain_males_regional_results, file = "../results/tables/ROIs_dep_brain_males.csv")

# ROI_males_regional %>% 
#        kable(digits=4, format = "html",
#        caption = "Female ROIs (PT~Regional Brain Measures)") %>% 
#                kable_styling(font_size = 15,
#                              position = "left",
#                              full_width = F) #%>% 
#       #save_kable(file = "../figs/female_ROIs_PT_brain_pilot_analysis.png")

```


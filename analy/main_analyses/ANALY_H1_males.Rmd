---
title: "ANALY_H1_females"
author: "Niamh MacSweeney" Credit to Amelia Edmondson-Stait for the template script
date: '2022-08-26'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lme4)
library(lmerTest)
library(nlme)
library(psych)
library(ggplot2)
library(readr)
library(pbapply)
library(gridExtra)
library(sandwich)
library(stringr)
library(kableExtra)

library(gmodels)
library(caret)

library(mice)
library(broom.mixed) #so that pool function runs properly

library(sjPlot) # table functions

setwd("/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/analy")
```

## Introduction

SCRIPT FOR MALES

This script runs the linear mixed effects model to test Hypothesis 1 in our main analysis. 

The bulk of this script deals with imputing missing data. 

We imputed missing data for individuals with PDS data (predictor)

We used multiple imputation using chained equations (using the "mice" package in R) to replace missing data for covariates and outcome variables for individuals with exposure data (pubertal timing (via PDS) measured at year 1) and individuals who at year 3 follow up data at the time of release 4.0 (Nov 2021) 

Predictive mean matching was used for continuous variables and logisitic regression for binary categorical variables.

Covariates were selected that predicted either missingness of variable to be imputed or associated with variable to be imputed. The variables had no less than 40% missing data. This reduces bias towards "missing not at random" (NMAR) and provides more accurate estimates. We will be imputing the outcome and covariates data only. 

Model: Depressive symptoms ~ pubertal timing	

Fixed covs: age, race/ethnicity, BMI, site, household income, parental current mood, population weighting variable.

Random: family, site

We will not impute household income as it was only collected at baseline. 

We will run sensitivity analysis with complete cases and report this analysis in the supplementary materials. 

Script Workflow
1. Load in Outcome (depression) and Covariates data 
2. Inspect variables and select auxiliary variables
2. Perform imputation on each variable
3. Save new imputed dataframe.
4. Run models using imputed dataframe
5. Compare model to complete case analysis

We will do imputation separately for males and females 


#LOAD DATA AND TIDY

```{r, load in data}

pds_y1 <- rio::import("/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/data/pds_timing_y1_R4.0.rds")
  
dep_vars <- rio::import("/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/data/CBCL_dep_all_yrs_R4.0.rds")
  
covs <- rio::import("/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/data/covs_main_R4.0.rds")

```

Remove variables we don't need/want to impute

```{r, tidy up variables}

pds_y1 <- pds_y1 %>% 
  select (-c("pds_m_pt_valid", "pds_f_pt_valid"))

```

### Merge

```{r, merge}
#inspect vars before merge
colnames(covs)
colnames(dep_vars)
colnames(pds_y1)

#merge by src_subject_id and sex as they are common to all dataframes 

#merge 1
df <- covs %>% 
  left_join(y=dep_vars, by= c("src_subject_id", "sex"))
  
#merge 2
df <- df %>% 
  left_join(y=pds_y1, by= c("src_subject_id", "sex"))

#check if merge worked okay
colnames(df)

```

###Reduce dataframe to correct sample

We will only include people with complete exposure (puberty) data and who had available year 3 data at release 4.0. 

Total N = 5727

```{r, filter sample}

df %>% 
  select(src_subject_id, pds_tot_all, interview_date_y3) %>% 
summary() 

#get number of complete cases for pds total and interview date y3
sum(complete.cases(df$pds_tot_all)) #N = 10,400
sum(complete.cases(df$interview_date_y3)) #6251

total_df <- df #save complete data frame before filter for reference


df <- df %>% 
  filter(!is.na(pds_tot_all)) %>% #N=10,400
  filter(!is.na(interview_date_y3)) #N = 5727

```


### Split by sex

We will do imputation separately for males and females so we need to split the dataframe by sex. 

Total N for Males = 3001

```{r, get females only}

df <- df %>% #N = 3001
  filter(sex == "M")

#remove female specific cols (pds_tot_f and pt_f and pds_tot_all)

df <- df %>% 
  select(-c(pds_tot_f, pds_tot_all, pt_f))

```

#EXPLORE DATA

Look at data structure to determine nature of missingness

Note: We will not be using the imaging related variables in imputation as we are only conducting imputation for H1. 

```{r, get list of variables}

#all vars including aux vars

variables <- c("src_subject_id", #character variable
               "sex",    #character variable                    
               "site_id",  "site_id_6m" , "site_id_y1", "site_id_18m", "site_id_y2", "site_id_y3", #character variable
               "interview_age",    #continuous score            
               "parent_dep_y0",  "parent_dep_y2", "parent_dep_y3", #continuous score
               "rel_family_id", #character variable
               "acs_raked_propensity_score_y0" , "acs_raked_propensity_score_y1", #continuous score
               "bmi_y0", "bmi_y1", "bmi_y2",  #continuous score
               "household_income_y0", #numeric variable - need to change
               "parent_high_ed_y0",
               "race_y0",  "race_6m", "race_y1", "race_18m",  "race_y2", #character variable
               "dti_mean_motion_y0",  "dti_mean_motion_y2",  #continuous score       
               "scanner_id_y2", #character variable
               "age_y3", #continuous score
               "cbcl_withdep_y0", "cbcl_withdep_y1", "cbcl_withdep_y2", "cbcl_withdep_y3", #continuous score
               "cbcl_anxdep_y0", "cbcl_anxdep_y1", "cbcl_anxdep_y2", "cbcl_anxdep_y3", #continuous score
               "pds_tot_f",  "pt_f" #continuous score
               )
  
```

Make sure variable classes are correct and scale continuous variables - we will scale all continuous variables in the dataframe. 

```{r, check variable type}

str(df)

#change rel_group_id from interger to factor
df$rel_family_id <- as.factor(df$rel_family_id)

#change household income and parent education from numeric to factor
df$household_income_y0 <- as.factor(df$household_income_y0)
df$parent_high_ed_y0<- as.factor(df$parent_high_ed_y0)


#Get all character columns we want to factorise
charCols <- (df[sapply(df, class) == 'character']) #extract char vars
charCols <- colnames(charCols) #get list of col names 

#change integer variables to numeric for ease of scaling later 
intCols <- df[sapply(df, class) == 'integer']
intCols <- colnames(intCols)

df <- df %>% 
  mutate_at(intCols, as.numeric)

# Get continuous variables we want to z-scale
conCols <- df[sapply(df, class) == 'numeric']
conCols <- colnames(conCols)
conCols <- conCols[!conCols %in% "acs_raked_propensity_score_y0"]

#make list of factor columns for ease of sorting new df later
facCols <- df[sapply(df, class) == 'factor']
facCols <- colnames(facCols)

# Factorise character variables, z-scale continuous, 
dataSub <- df %>%
  mutate_at(charCols, as.factor) %>%
  mutate_at(facCols, as.factor) %>% 
  mutate_at(conCols, scale) %>% 
  mutate_at(conCols, as.numeric)

str(dataSub)
head(dataSub)

```

##Explore missingness

```{r, explore missingness}

summary(dataSub)

```

## Explore outcome depression measure

As only partial year 3 data was available at release 4.0, 46 participants have other year 3 measures but are missing the depression outcome measure. We will impute depression outcome measures for these participants. 

```{r, outcome imputation diagnostics}

dataSub %>% 
  filter(is.na(cbcl_withdep_y3)) %>% #has missing depression data at year 3
  filter(!is.na(site_id_y3)) %>% #but did complete other measures (e.g., longitudinal tracking data)
  filter(!is.na(interview_date_y3)) %>%  #double check with interview date variable
  nrow() #46 participants 

```

##Is missing data >40%?

We will only impute variables with less than 40% missing data.

Variables with missing data that is >40%
- parent_dep_y3 = 100%

We won't be able to use parental year 3 depression as a covariate due to it not being available. We will use year 2 parental depression instead as it is the next closest time point.


```{r, % missing}

summary(dataSub)

# Which variables have <= 40% missing:
propNA <- round(colSums(is.na(dataSub))/nrow(dataSub), 3) ;propNA
colnames(dataSub)[propNA > 0.40]

```

##Variables to impute:

- youth depression year 3 (NA =46)
- BMI_y1 (NA=43)
- parental mood_y2 (NA=38)

##Variables NOT imputed:
- household income - this info only available at baseline (looked at parental education as an aux variable but all participants with missing income data also have missing education data!)
- Race: Participants with missing data at baseline, also have missing data at all other timepoints
- Site: no NAs for baseline or year 1
- Age: no NAs
- Sex: no NAs
- ACS population stratification weight: No NAs

## Check auxiliary variables 

We will only use variables as auxiliary variables with â‰¤ 40% missingness

Youth Depression
```{r, outcome data missing}

dataSub %>% 
  filter(is.na(cbcl_withdep_y3)) %>%
  filter(!is.na(cbcl_withdep_y2)) %>%
  nrow() 

#46 participants are missing depression outcome data
#26 participants are missing outcome data at year 3 but not at year 2, can impute 20

dataSub %>% 
  filter(is.na(cbcl_withdep_y2)) %>%
  filter(!is.na(cbcl_withdep_y1)) %>%
  nrow() 

#41 participants are missing outcome data at year 2 but not at year 1

dataSub %>% 
  filter(is.na(cbcl_withdep_y1)) %>%
  filter(!is.na(cbcl_withdep_y0)) %>%
  nrow() 
#0 participants are missing outcome data at year 1 but not at baseline (y0)

```

BMI
```{r, explore BMI missingness}

#### Imputing BMI:
dataSub %>% 
  filter(is.na(bmi_y1)) %>%
  filter(!is.na(bmi_y0)) %>%
  nrow() 
# 43 participants have BMI missing at y1
# 41 participants have BMI missing at y1 but not at y0

```
Parental Depression 
```{r, explore parental dep missingness}

### Imputing parental depression
dataSub %>% 
  filter(is.na(parent_dep_y2)) %>%
  filter(!is.na(parent_dep_y0)) %>%
  nrow() 
# 38 participants have missing data at year 2
# 0 Participants have missing data at y0

# Therefore we can impute 38 participants meaning there is 0 missing parental depression data. 

```

Race missingness - we will not impute
```{r, race missingness}

### Imputing race_y0
dataSub %>% 
 filter(is.na(race_y0)) %>%
  filter(!is.na(race_18m)) %>%
  nrow() 

#participants with missing race data at year 0 also had missing race data at all other time points so we cannot impute this variable. 

```

Household income missingness = we will not impute to keep consistent with female dataframe. 
```{r, income missingness}
dataSub %>% 
 filter(is.na(household_income_y0)) %>%
  filter(!is.na(parent_high_ed_y0)) %>%
  nrow()

#only 1 participant with missing income data has present parental education data. 

```

We need to check to see if the variables we are not imputing (e.g., race and household income) predict missing depression outcome data. If so, we will need to acknowledge this as a limitation. 

```{r, check variables not imputing}

auxVars <- c("race_y0" , "household_income_y0")

imputeVars <- c("cbcl_withdep_y3") 
             

getVars <- function(imputeVars){
  newAuxVars <- lapply(imputeVars, function(outcome){
    lapply(auxVars, function(predictor){
      if( class(dataSub[,outcome]) == "factor" ){
        family <- "binomial"
      }else{
        family <- "gaussian"
      }
      formula <- paste0(outcome, " ~ ", predictor)
      fit <- glm(formula = formula, data = dataSub, family = family)
      sig <- summary(fit)$coefficients %>%
        as.data.frame() %>%
        slice(-1) %>%
        filter(.[[4]] < 0.05) %>%
        rownames() 
      if(is_empty(sig)){
        sig <- ""
      }
      sig
    }) %>% unlist() %>% unique()
  }) 
  return(newAuxVars)
}

newAuxVars <- getVars(imputeVars)
newAuxVars <- newAuxVars %>% unlist() %>% unique()
newAuxVars <- newAuxVars[!newAuxVars %in% ""]
length(auxVars) == length(newAuxVars) #FALSE
#Race and income do not predict year 3 depression. 

# Do they predict missingness?
getVarsMiss <- function(imputeVars){
  newAuxVars <- lapply(imputeVars, function(outcome){
    lapply(auxVars, function(predictor){
      formula <- paste0("is.na(", outcome, ") ~ ", predictor)
      fit <- glm(formula = formula, data = dataSub, family = "binomial")
      sig <- summary(fit)$coefficients %>%
        as.data.frame() %>%
        slice(-1) %>%
        filter(.[[4]] < 0.05) %>%
        rownames() 
      if(is_empty(sig)){
        sig <- ""
      }
      sig
    }) %>% unlist() %>% unique()
  }) 
}
newAuxVars <- getVarsMiss(imputeVars)
newAuxVars <- newAuxVars %>% unlist() %>% unique()
newAuxVars <- newAuxVars[!newAuxVars %in% ""]
newAuxVars 


#It looks like certain (higher) bands of household income predict missingness in outcome measure:  

#Namely, income categories 07, 08 and 09:

#7=$50,000 through $74,999; 8= $75,000 through $99,999; 9=$100,000 through $199,999
```

Do the auxilary variables predict missingness? 

```{r, aux loop}
# Loop through each variable we want to impute to see which auxillary variables predict that variable or missingness.

                   
auxVars <- c("cbcl_withdep_y0", "cbcl_withdep_y1", "cbcl_withdep_y2","cbcl_anxdep_y1",
             "cbcl_anxdep_y2", "cbcl_anxdep_y3", "cbcl_anxdep_y0",
             "parent_dep_y0", "bmi_y0")

imputeVars <- c("cbcl_withdep_y3", "parent_dep_y2","bmi_y1") 
             

getVars <- function(imputeVars){
  newAuxVars <- lapply(imputeVars, function(outcome){
    lapply(auxVars, function(predictor){
      if( class(dataSub[,outcome]) == "factor" ){
        family <- "binomial"
      }else{
        family <- "gaussian"
      }
      formula <- paste0(outcome, " ~ ", predictor)
      fit <- glm(formula = formula, data = dataSub, family = family)
      sig <- summary(fit)$coefficients %>%
        as.data.frame() %>%
        slice(-1) %>%
        filter(.[[4]] < 0.05) %>%
        rownames() 
      if(is_empty(sig)){
        sig <- ""
      }
      sig
    }) %>% unlist() %>% unique()
  }) 
  return(newAuxVars)
}

newAuxVars <- getVars(imputeVars)
newAuxVars <- newAuxVars %>% unlist() %>% unique()
newAuxVars <- newAuxVars[!newAuxVars %in% ""]
length(auxVars) == length(newAuxVars) #TRUE

#setdiff(auxVars, newAuxVars)

# All auxiliary variables predict a variable we want to impute

# Do they also predict missingness?
getVarsMiss <- function(imputeVars){
  newAuxVars <- lapply(imputeVars, function(outcome){
    lapply(auxVars, function(predictor){
      formula <- paste0("is.na(", outcome, ") ~ ", predictor)
      fit <- glm(formula = formula, data = dataSub, family = "binomial")
      sig <- summary(fit)$coefficients %>%
        as.data.frame() %>%
        slice(-1) %>%
        filter(.[[4]] < 0.05) %>%
        rownames() 
      if(is_empty(sig)){
        sig <- ""
      }
      sig
    }) %>% unlist() %>% unique()
  }) 
}
newAuxVars <- getVarsMiss(imputeVars)
newAuxVars <- newAuxVars %>% unlist() %>% unique()
newAuxVars <- newAuxVars[!newAuxVars %in% ""]
newAuxVars 

# cbcl_withdep_y0" "cbcl_withdep_y1" "bmi_y0" predict missingness in the variables we want to impute. 

```

## Check correlation between variables. Auxillary vars and variables we want to impute are highly correlated. 

```{r, corr between vars}

# Correlation between aux vars and vars to be imputed 
library(corrplot)
corSub <- dataSub %>% 
  dplyr::select(cbcl_withdep_y0, cbcl_withdep_y1, cbcl_withdep_y2,cbcl_withdep_y3, cbcl_anxdep_y0, cbcl_anxdep_y1, cbcl_anxdep_y2, cbcl_anxdep_y3, parent_dep_y0, parent_dep_y2, bmi_y0, bmi_y1)
M <- cor(corSub, use = "pairwise.complete.obs")
corrplot(M)

```


## Make dataframe of main variables and auxillary ones only 

```{r, make final df to impute}

mainVars <- c("src_subject_id", 
               "sex",                       
               "site_id_y1",         
              "parent_dep_y2",
               "rel_family_id",
               "acs_raked_propensity_score_y0", 
               "bmi_y1",  
               "household_income_y0", 
               "race_y0",
               "age_y3", 
              "cbcl_withdep_y3",
              "pt_m"
               )
mainVars

#We already have list of aux vars ---> auxVars
auxVars

#filter dataframe to main vars and aux vars

dataSub <- dataSub %>% 
  select(mainVars, auxVars) # N = 3001, 21 variables 

colnames(dataSub) #looks good!

#We are not imputing race and income so reduce dataframe to participants with complete cases for these variables. 

dataSub <- dataSub %>% # N = 3001
  filter(!is.na(household_income_y0)) %>% 
  filter(!is.na(race_y0)) #2792
  
colnames(dataSub)
head(dataSub)#Looks good! 

#Note that all numeric variables except the acs_ranked propensity score have been scaled!!

```


#RUN IMPUTATION 

A small number of imputations is fine when no. of missing data is small.
But a larger M makes the imputation more reproducible when using a different seed.
M should be >= 100 * fraction of missing information (FMI).
It's also possible to do a trial and error approach to see if your estimates differ
after running the imputation 2-3 times with the same M.

#Imputation set up

Very good tutorials on missing data and mice: 
- https://statistics.ohlsen-web.de/multiple-imputation-with-mice/ 
- https://stefvanbuuren.name/fimd/sec-modelform.html

We do not want to use the mice default "massive imputation" where every variable in the dataset is used to predict the missing data. If these variables don't correlate with our variable of interest, they can introduce noise to our estimation. Instead, we will only use the auxillary variables to predict missing data in our target variables, and variables that have a correlation of r=.2.

We specify these settings in the PredMat using the function quickpred. In the prediction matrix, the rows correspond to incomplete target variables, in the order they appear in our dataframe. A value of 1 indicates that the column variable is a predictor to impute the target (row) variable, and a 0 means that it is not used.

```{r, imputation set up}

# first get default predictor matrix
predMat <- quickpred(dataSub, 
                      include=auxVars,
                      exclude=NULL,
                      mincor = 0.2)
predMat

# Rows are variables to be imputed, cols are variables used to impute.

meth <- make.method(dataSub)
meth

#run the imputation 
start_time <- Sys.time()
ModImps <- mice(dataSub, m=100, predictorMatrix=predMat, seed=270795, printFlag=FALSE, method = meth)
end_time <- Sys.time()
end_time - start_time

```


#RUN MODELS

##Imputed dataframes
```{r, imputed models}
# This works:
MIfitBase <- with(data = ModImps, exp = lmerTest::lmer(cbcl_withdep_y3 ~ pt_m + age_y3 + race_y0 
                            + (1|site_id_y1) + (1|rel_family_id),
                            control = lmerControl(optimizer ="bobyqa")))

resMIfitBase <-summary(pool(MIfitBase))
resMIfitBase

MIfitFull <- with(data = ModImps, exp = lmerTest::lmer(cbcl_withdep_y3 ~ pt_m + age_y3 + race_y0 + household_income_y0 + parent_dep_y2
                            + (1|site_id_y1) + (1|rel_family_id),
                            control = lmerControl(optimizer ="bobyqa"),
                            weights = acs_raked_propensity_score_y0))


resMIfitFull <- summary(pool(MIfitFull))
resMIfitFull

#pasting imputed results here 

#base 
#               term    estimate  std.error  statistic       df     p.value
# 1      (Intercept)  0.02364781 0.03016421  0.7839692 2767.193 0.433125258
# 2             pt_m  0.05480874 0.02013136  2.7225556 2743.300 0.006518892
# 3           age_y3  0.03550608 0.01914568  1.8545221 2752.197 0.063771390
# 4     race_y0Black -0.19836128 0.07317689 -2.7107093 2741.532 0.006755784
# 5     race_y0Asian -0.25655021 0.12687825 -2.0220188 2768.809 0.043270399
# 6 race_y0AIAN/NHPI -0.02919849 0.26800956 -0.1089457 2717.707 0.913253585
# 7     race_y0Other  0.03723348 0.11013510  0.3380710 2695.804 0.735336033
# 8     race_y0Mixed  0.09702783 0.06561207  1.4788107 2711.004 0.139307094

#Full 
#                      term    estimate  std.error  statistic       df    p.value
#                (Intercept) 0.22659830 0.13224058  1.7135308 2653.830 0.08673172
# 2                   pt_m  0.04261869 0.01966111  2.1676646 2736.108 0.03027019
# 3                 age_y3  0.02845592 0.01860572  1.5294183 2741.997 0.12627612
# 4           race_y0Black -0.19337443 0.07681970 -2.5172506 2734.668 0.01188420
# 5           race_y0Asian -0.08698124 0.11572665 -0.7516094 2748.193 0.45235035
# 6       race_y0AIAN/NHPI  0.06449278 0.24524815  0.2629695 2642.246 0.79259462
# 7           race_y0Other  0.02868415 0.10574927  0.2712468 2611.526 0.78622268
# 8           race_y0Mixed  0.07729128 0.07244088  1.0669566 2715.670 0.28608627
# 9   household_income_y02 -0.37262083 0.17154617 -2.1721315 2681.434 0.02993310
# 10  household_income_y03 -0.27716998 0.19384668 -1.4298413 2729.349 0.15287704
# 11  household_income_y04  0.03129478 0.15563460  0.2010785 2617.540 0.84065278
# 12  household_income_y05 -0.16694274 0.14999297 -1.1130038 2653.708 0.26580762
# 13  household_income_y06 -0.04415870 0.14135386 -0.3123983 2664.955 0.75476232
# 14  household_income_y07 -0.18803560 0.13704643 -1.3720576 2665.482 0.17016096
# 15  household_income_y08 -0.24138182 0.13826577 -1.7457814 2665.859 0.08096414
# 16  household_income_y09 -0.23501570 0.13518068 -1.7385303 2662.724 0.08223301
# 17 household_income_y010 -0.25053199 0.14433556 -1.7357606 2660.352 0.08272195
# 18         parent_dep_y2  0.30351238 0.02024828 14.9895359 2511.578 0.00000000





```

##Complete cases
```{r, complete case models}

CCfitBase <- lmerTest::lmer(cbcl_withdep_y3 ~ pt_m + age_y3 + race_y0 
                            + (1|site_id_y1) + (1|rel_family_id),
                            control = lmerControl(optimizer ="bobyqa"),
                            data = dataSub,
                            na.action = na.exclude,
                       )



CCfitFull <- lmerTest::lmer(cbcl_withdep_y3 ~ pt_m + age_y3 + race_y0 
                            + household_income_y0 + parent_dep_y2
                            + (1|site_id_y1) + (1|rel_family_id),
                            control = lmerControl(optimizer ="bobyqa"),
                            weights = acs_raked_propensity_score_y0,
                            data = dataSub,
                            na.action = na.exclude
                       )


resCCfitFull <- summary(CCfitFull)
resCCfitFull


#Plot results 

plot_model(CCfitBase)

```
#EXPORT RESULTS TABLE 

```{r, imputed}

sjPlot::tab_model(CCfitBase, CCfitFull,
                  show.se = TRUE,
                  show.df = FALSE,
                  show.ci = FALSE,
                  digits = 3,
                  title = "Males â€” Main Effect of Pubertal Timing and Depression",
                  dv.labels = c("Base", "Full"),
                  string.se = "SE",
                  string.p = "P-Value", 
                  file = "/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/figs/CC_male_H1res.html")


```








##Export tidied dataframe 

```{r, export data}
setwd("/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/data")


saveRDS(dataSub, "data_main_analy_males.rds")
```

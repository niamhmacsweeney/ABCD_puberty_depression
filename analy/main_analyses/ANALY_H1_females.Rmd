---
title: "ANALY_H1_females"
author: "Niamh MacSweeney" Credit to Amelia Edmondson-Stait for the template script
date: '2022-08-26'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lme4)
library(lmerTest)
library(nlme)
library(psych)
library(ggplot2)
library(readr)
library(pbapply)
library(gridExtra)
library(sandwich)
library(stringr)
library(kableExtra)

library(gmodels)
library(caret)

library(mice)
library(broom.mixed) #so that pool function runs properly

library(sjPlot) # table functions

setwd("/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/analy")
```

## Introduction

SCRIPT FOR FEMALES

This script runs the linear mixed effects model to test Hypothesis 1 in our main analysis. 

The bulk of this script deals with imputing missing data. 

We imputed missing data for individuals with PDS data (predictor)

We used multiple imputation using chained equations (using the "mice" package in R) to replace missing data for covariates and outcome variables for individuals with exposure data (pubertal timing (via PDS) measured at year 1) and individuals who at year 3 follow up data at the time of release 4.0 (Nov 2021) 

Predictive mean matching was used for continuous variables and logisitic regression for binary categorical variables.

Covariates were selected that predicted either missingness of variable to be imputed or associated with variable to be imputed. The variables had no less than 40% missing data. This reduces bias towards "missing not at random" (NMAR) and provides more accurate estimates. We will be imputing the outcome and covariates data only. 

Model: Depressive symptoms ~ pubertal timing	

Fixed covs: age, race/ethnicity, BMI, site, household income, parental current mood, population weighting variable.

Random: family, site

We will not impute household income as it was only collected at baseline. 

We will run sensitivity analysis with complete cases and report this analysis in the supplementary materials. 

Script Workflow
1. Load in Outcome (depression) and Covariates data 
2. Inspect variables and select auxiliary variables
2. Perform imputation on each variable
3. Save new imputed dataframe.
4. Run models using imputed dataframe
5. Compare model to complete case analysis

We will do imputation separately for males and females 


#LOAD DATA AND TIDY

```{r, load in data}

pds_y1 <- rio::import("/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/data/pds_timing_y1_R4.0.rds")
  
dep_vars <- rio::import("/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/data/CBCL_dep_all_yrs_R4.0.rds")
  
covs <- rio::import("/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/data/covs_main_R4.0.rds")

```

Remove variables we don't need/want to impute

```{r, tidy up variables}

pds_y1 <- pds_y1 %>% 
  select (-c("pds_m_pt_valid", "pds_f_pt_valid", "pds_p_ss_female_category" ,"pds_p_ss_male_category", "pds_1_p",        "pds_2_p", "pds_3_p","pds_m5_p",  "pds_m4_p",  "pds_f4_p", "pds_f5b_p", "gonad_avg", "adren_avg", "gonad_f", "gonad_m", "adren_f", "adren_m", "age_years"))

colnames(pds_y1)


```

### Merge

```{r, merge}
#inspect vars before merge
colnames(covs)
colnames(dep_vars)
colnames(pds_y1)

#merge by src_subject_id and sex as they are common to all dataframes 

#merge 1
df <- covs %>% 
  left_join(y=dep_vars, by= c("src_subject_id", "sex"))
  
#merge 2
df <- df %>% 
  left_join(y=pds_y1, by= c("src_subject_id", "sex"))

#check if merge worked okay
colnames(df)

```

###Reduce dataframe to correct sample

We will only include people with complete exposure (puberty) data and who had available year 3 data at release 4.0. 

Total N = 5727

```{r, filter sample}

df %>% 
  select(src_subject_id, pds_tot_all, interview_date_y3) %>% 
summary() 

#get number of complete cases for pds total and interview date y3
sum(complete.cases(df$pds_tot_all)) #N = 10,400
sum(complete.cases(df$interview_date_y3)) #6251

total_df <- df #save complete data frame before filter for reference


df <- df %>% 
  filter(!is.na(pds_tot_all)) %>% #N=10,400
  filter(!is.na(interview_date_y3)) #N = 5727

```


### Split by sex

We will do imputation separately for males and females so we need to split the dataframe by sex. 

Total N for females = 2726

```{r, get females only}

df <- df %>% #N = 2726
  filter(sex == "F")

#remove male specific cols (pds_tot_m and pt_m and pds_tot_all) #should have 43 variables after. 

df <- df %>% 
  select(-c(pds_tot_m, pds_tot_all, pt_m, gonad_pt_m, adren_pt_m))

```

#EXPLORE DATA

Look at data structure to determine nature of missingness

Note: We will not be using the imaging related variables in imputation as we are only conducting imputation for H1. 

```{r, get list of variables}

#all vars including aux vars

variables <- c("src_subject_id", #character variable
               "sex",    #character variable                    
               "site_id",  "site_id_6m" , "site_id_y1", "site_id_18m", "site_id_y2", "site_id_y3", #character variable
               "interview_age",    #continuous score            
               "parent_dep_y0",  "parent_dep_y2", "parent_dep_y3", #continuous score
               "rel_family_id", #character variable
               "acs_raked_propensity_score_y0" , "acs_raked_propensity_score_y1", #continuous score
               "bmi_y0", "bmi_y1", "bmi_y2",  #continuous score
               "household_income_y0", #numeric variable - need to change
               "parent_high_ed_y0",
               "race_y0",  "race_6m", "race_y1", "race_18m",  "race_y2", #character variable
               "dti_mean_motion_y0",  "dti_mean_motion_y2",  #continuous score       
               "scanner_id_y2", #character variable
               "age_years", #continuous score
               "cbcl_withdep_y0", "cbcl_withdep_y1", "cbcl_withdep_y2", "cbcl_withdep_y3", #continuous score
               "cbcl_anxdep_y0", "cbcl_anxdep_y1", "cbcl_anxdep_y2", "cbcl_anxdep_y3", #continuous score
               "pds_tot_f",  "pt_f", #continuous score
               "gonad_pt_f", "adren_pt_f"
               )
  
```

Make sure variable classes are correct and scale continuous variables - we will scale all continuous variables in the dataframe. 

##Scaling variables
```{r, check variable type}

str(df)

#change rel_group_id from interger to factor
df$rel_family_id <- as.factor(df$rel_family_id)

#change household income and parent education from numeric to factor
df$household_income_y0 <- as.factor(df$household_income_y0)
df$parent_high_ed_y0<- as.factor(df$parent_high_ed_y0)


#Get all character columns we want to factorise
charCols <- (df[sapply(df, class) == 'character']) #extract char vars
charCols <- colnames(charCols) #get list of col names 

#change integer variables to numeric for ease of scaling later 
intCols <- df[sapply(df, class) == 'integer']
intCols <- colnames(intCols)

df <- df %>% 
  mutate_at(intCols, as.numeric)

# Get continuous variables we want to z-scale
conCols <- df[sapply(df, class) == 'numeric']
conCols <- colnames(conCols)
conCols <- conCols[!conCols %in% c("acs_raked_propensity_score_y0","cbcl_withdep_y3")] 
#don't standardise outcome as it is count data. 

#make list of factor columns for ease of sorting new df later
facCols <- df[sapply(df, class) == 'factor']
facCols <- colnames(facCols)

# Factorise character variables, z-scale continuous, 
dataSub <- df %>%
  mutate_at(charCols, as.factor) %>%
  mutate_at(facCols, as.factor) %>% 
  mutate_at(conCols, scale) %>% 
  mutate_at(conCols, as.numeric)

str(dataSub)
head(dataSub)

```

##Explore missingness

```{r, explore missingness}

summary(dataSub)

```

## Explore outcome depression measure

As only partial year 3 data was available at release 4.0, 46 participants have other year 3 measures but are missing the depression outcome measure. We will impute depression outcome measures for these participants. 

```{r, outcome imputation diagnostics}

dataSub %>% 
  filter(is.na(cbcl_withdep_y3)) %>% #has missing depression data at year 3
  filter(!is.na(site_id_y3)) %>% #but did complete other measures (e.g., longitudinal tracking data)
  filter(!is.na(interview_date_y3)) %>%  #double check with interview date variable
  nrow() #46 participants 

```

##Is missing data >40%?

We will only impute variables with less than 40% missing data.


Variables with missing data that is >40%
- parent_dep_y3 = 100%

We won't be able to use parental year 3 depression as a covariate due to it not being available. We will use year 2 parental depression instead as it is the next closest time point.


```{r, % missing}

# Which variables have <= 40% missing:
propNA <- round(colSums(is.na(dataSub))/nrow(dataSub), 3) ;propNA
colnames(dataSub)[propNA > 0.40]

```

##Variables to impute:

- youth depression year 3 (NA =46)
- BMI (NA=51)
- parental mood (NA=35)

##Variables NOT imputed:
- household income - this info only available at baseline (looked at parental education as an aux variable but all participants with missing income data also have missing education data!)
- Race: Participants with missing data at baseline, also have missing data at all other timepoints
- Site: no NAs for baseline or year 1
- Age: no NAs
- Sex: no NAs
- ACS population stratification weight: No NAs

## Check auxiliary variables 

We will only use variables as auxiliary variables with ≤ 40% missingness

Youth Depression
```{r, outcome data missing}

dataSub %>% 
  filter(is.na(cbcl_withdep_y3)) %>%
  filter(!is.na(cbcl_withdep_y2)) %>%
  nrow() 

#46 participants are missing depression outcome data
#34 participants are missing outcome data at year 3 but not at year 2, can impute 12

dataSub %>% 
  filter(is.na(cbcl_withdep_y2)) %>%
  filter(!is.na(cbcl_withdep_y1)) %>%
  nrow() 

#35 participants are missing outcome data at year 2 but not at year 1

dataSub %>% 
  filter(is.na(cbcl_withdep_y1)) %>%
  filter(!is.na(cbcl_withdep_y0)) %>%
  nrow() 
#1 participant is missing outcome data at year 1 but not at baseline (y0)

```

BMI
```{r, explore BMI missingness}

#### Imputing BMI:
dataSub %>% 
  filter(is.na(bmi_y0)) %>%
  filter(!is.na(bmi_y1)) %>%
  nrow() 
# 15 participants have BMI missing at y0 (baseline)
# 8 participants have BMI missing at y0 but not at y1
# Therefore we can impute 8 participants BMI meaning only 7 participants have missing BMI.

```
Parental Depression 
```{r, explore parental dep missingness}

### Imputing parental depression
dataSub %>% 
  filter(is.na(parent_dep_y2)) %>%
  filter(!is.na(parent_dep_y0)) %>%
  nrow() 
# 35 participants have missing data at year 2
# 0 Participants have missing data at y0

# Therefore we can impute 35 participants meaning there is 0 missing parental depression data. 

```

Race missingness
```{r, race missingness}

### Imputing race_y0
dataSub %>% 
 filter(is.na(race_y0)) %>%
  filter(!is.na(race_18m)) %>%
  nrow() 

#participants with missing race data at year 0 also had missing race data at all other time points so we cannot impute this variable. 

```

Household income missingness 
```{r, income missingness}
dataSub %>% 
 filter(is.na(household_income_y0)) %>%
  filter(!is.na(parent_high_ed_y0)) %>%
  nrow()

#all participants with missing income data also have missing parental education data. 

```

We need to check to see if the variables we are not imputing (e.g., race and household income) predict missing depression outcome data. If so, we will need to acknowledge this as a limitation. 

```{r, check variables not imputing}

auxVars <- c("race_y0" , "household_income_y0")

imputeVars <- c("cbcl_withdep_y3") 
             

getVars <- function(imputeVars){
  newAuxVars <- lapply(imputeVars, function(outcome){
    lapply(auxVars, function(predictor){
      if( class(dataSub[,outcome]) == "factor" ){
        family <- "binomial"
      }else{
        family <- "gaussian"
      }
      formula <- paste0(outcome, " ~ ", predictor)
      fit <- glm(formula = formula, data = dataSub, family = family)
      sig <- summary(fit)$coefficients %>%
        as.data.frame() %>%
        slice(-1) %>%
        filter(.[[4]] < 0.05) %>%
        rownames() 
      if(is_empty(sig)){
        sig <- ""
      }
      sig
    }) %>% unlist() %>% unique()
  }) 
  return(newAuxVars)
}

newAuxVars <- getVars(imputeVars)
newAuxVars <- newAuxVars %>% unlist() %>% unique()
newAuxVars <- newAuxVars[!newAuxVars %in% ""]
length(auxVars) == length(newAuxVars) #FALSE
#Race and income do not predict year 3 depression. 

# Do they predict missingness?
getVarsMiss <- function(imputeVars){
  newAuxVars <- lapply(imputeVars, function(outcome){
    lapply(auxVars, function(predictor){
      formula <- paste0("is.na(", outcome, ") ~ ", predictor)
      fit <- glm(formula = formula, data = dataSub, family = "binomial")
      sig <- summary(fit)$coefficients %>%
        as.data.frame() %>%
        slice(-1) %>%
        filter(.[[4]] < 0.05) %>%
        rownames() 
      if(is_empty(sig)){
        sig <- ""
      }
      sig
    }) %>% unlist() %>% unique()
  }) 
}
newAuxVars <- getVarsMiss(imputeVars)
newAuxVars <- newAuxVars %>% unlist() %>% unique()
newAuxVars <- newAuxVars[!newAuxVars %in% ""]
newAuxVars 


#It looks like Asian, Other, race predict missingness in depression outcome measure. We will need to acknowledge this in our discussion. Household income do not predict missingness. 

#How to get stats from this - check later. 
```

Do the auxilary variables predict missingness? 

```{r, aux loop}
# Loop through each variable we want to impute to see which auxillary variables predict that variable or missingness.

                   
auxVars <- c("cbcl_withdep_y0", "cbcl_withdep_y1", "cbcl_withdep_y2","cbcl_anxdep_y1",
             "cbcl_anxdep_y2", "cbcl_anxdep_y3", "cbcl_anxdep_y0",
             "parent_dep_y0", "bmi_y0")

imputeVars <- c("cbcl_withdep_y3", "parent_dep_y2","bmi_y1") 
             

getVars <- function(imputeVars){
  newAuxVars <- lapply(imputeVars, function(outcome){
    lapply(auxVars, function(predictor){
      if( class(dataSub[,outcome]) == "factor" ){
        family <- "binomial"
      }else{
        family <- "gaussian"
      }
      formula <- paste0(outcome, " ~ ", predictor)
      fit <- glm(formula = formula, data = dataSub, family = family)
      sig <- summary(fit)$coefficients %>%
        as.data.frame() %>%
        slice(-1) %>%
        filter(.[[4]] < 0.05) %>%
        rownames() 
      if(is_empty(sig)){
        sig <- ""
      }
      sig
    }) %>% unlist() %>% unique()
  }) 
  return(newAuxVars)
}

newAuxVars <- getVars(imputeVars)
newAuxVars <- newAuxVars %>% unlist() %>% unique()
newAuxVars <- newAuxVars[!newAuxVars %in% ""]
length(auxVars) == length(newAuxVars) #TRUE

#setdiff(auxVars, newAuxVars)

# All auxiliary variables predict a variable we want to impute

# Do they also predict missingness?
getVarsMiss <- function(imputeVars){
  newAuxVars <- lapply(imputeVars, function(outcome){
    lapply(auxVars, function(predictor){
      formula <- paste0("is.na(", outcome, ") ~ ", predictor)
      fit <- glm(formula = formula, data = dataSub, family = "binomial")
      sig <- summary(fit)$coefficients %>%
        as.data.frame() %>%
        slice(-1) %>%
        filter(.[[4]] < 0.05) %>%
        rownames() 
      if(is_empty(sig)){
        sig <- ""
      }
      sig
    }) %>% unlist() %>% unique()
  }) 
}
newAuxVars <- getVarsMiss(imputeVars)
newAuxVars <- newAuxVars %>% unlist() %>% unique()
newAuxVars <- newAuxVars[!newAuxVars %in% ""]
newAuxVars 

# cbcl_withdep_y0" "cbcl_withdep_y2" "cbcl_withdep_y1" "bmi_y0", "cbcl_anxdep_y2" all predict missingness in the variables we want to impute. 

```

## Check correlation between variables. Auxillary vars and variables we want to impute are highly correlated. 

```{r, corr between vars}

# Correlation between aux vars and vars to be imputed 
library(corrplot)
corSub <- dataSub %>% 
  dplyr::select(cbcl_withdep_y0, cbcl_withdep_y1, cbcl_withdep_y2,cbcl_withdep_y3, cbcl_anxdep_y0, cbcl_anxdep_y1, cbcl_anxdep_y2, cbcl_anxdep_y3, parent_dep_y0, parent_dep_y2, bmi_y0, bmi_y1)
M <- cor(corSub, use = "pairwise.complete.obs")
corrplot(M)

```


## Make dataframe of main variables and auxillary ones only 

```{r, make final df to impute}

mainVars <- c("src_subject_id", 
               "sex",                       
               "site_id_y1",         
              "parent_dep_y2",
               "rel_family_id",
               "acs_raked_propensity_score_y0", 
               "bmi_y1",  
               "household_income_y0", 
               "race_y0",
               "age_y3", 
              "cbcl_withdep_y3",
              "pt_f",
              "gonad_pt_f", #pt timing variables to look at in exploratory analyses
              "adren_pt_f"
               )
mainVars

#We already have list of aux vars ---> auxVars
auxVars

#filter dataframe to main vars and aux vars

dataSub <- dataSub %>% 
  select(mainVars, auxVars) # N = 2726 

colnames(dataSub) #looks good!

#Troubleshooting (16/09/22) - having issues including race and income in imputation model. No good auxillary variables that predict them. 

#See if imputation works when removing individuals with missing race and income data (this removed 193 people)

dataSub <- dataSub %>% # N = 2726 
  filter(!is.na(household_income_y0)) %>% #2558
  filter(!is.na(race_y0)) #2533
  
colnames(dataSub)
head(dataSub)#Looks good! 

#Note that all numeric variables, except the acs_raked_propensity_score and outcome depression measure have been scaled!!

```
#RUN COMPLETE CASE ANALYSIS 
##Complete cases
```{r, complete case models}
CCfitBase_test <- glmer(cbcl_withdep_y3 ~ pt_f + age_y3 + race_y0 
                           + (1|site_id_y1) + (1|rel_family_id),
                            control = glmerControl(calc.derivs = FALSE),
                            family = 'poisson',
                            data = dataSub,
                            na.action = na.exclude,
                       )

resCCfitBase_test <- summary(summary(CCfitBase_test))
resCCfitBase_test

#save results 

saveRDS(resCCfitBase, "/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/results/main_analysis/ resCCfitBase_females.rds")

CCfitFull_test <- glmer(cbcl_withdep_y3 ~ pt_f + age_y3 + race_y0 
                            + household_income_y0 + parent_dep_y2
                            + (1|site_id_y1) + (1|rel_family_id),
                            control = glmerControl(calc.derivs = FALSE),
                            family = 'poisson',
                            weights = acs_raked_propensity_score_y0,
                            data = dataSub,
                            na.action = na.exclude
                       )

resCCfitFull_test <- summary(CCfitFull_test)
resCCfitFull_test

saveRDS(resCCfitFull, "/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/results/main_analysis/ resCCfitFull_females.rds")


check

```


#RUN IMPUTATION ANALYSIS

A small number of imputations is fine when no. of missing data is small.
But a larger M makes the imputation more reproducible when using a different seed.
M should be >= 100 * fraction of missing information (FMI).
It's also possible to do a trial and error approach to see if your estimates differ
after running the imputation 2-3 times with the same M.

#Imputation set up

Very good tutorials on missing data and mice: 
- https://statistics.ohlsen-web.de/multiple-imputation-with-mice/ 
- https://stefvanbuuren.name/fimd/sec-modelform.html

We do not want to use the mice default "massive imputation" where every variable in the dataset is used to predict the missing data. If these variables don't correlate with our variable of interest, they can introduce noise to our estimation. Instead, we will only use the auxillary variables to predict missing data in our target variables, and variables that have a correlation of r=.2.

We specify these settings in the PredMat using the function quickpred. In the prediction matrix, the rows correspond to incomplete target variables, in the order they appear in our dataframe. A value of 1 indicates that the column variable is a predictor to impute the target (row) variable, and a 0 means that it is not used.

```{r, imputation set up}

# first get default predictor matrix
predMat <- quickpred(dataSub, 
                      include=auxVars,
                      exclude=NULL,
                      mincor = 0.2)

# Rows are variables to be imputed, cols are variables used to impute.

meth <- make.method(dataSub)
meth

#run the imputation 
start_time <- Sys.time()
ModImps <- mice(dataSub, m=100, predictorMatrix=predMat, seed=270795, printFlag=FALSE, method = meth)
end_time <- Sys.time()
end_time - start_time

```


#RUN MODELS

##Imputed dataframes
```{r, imputed models}

#Base model
MIfitBase <- with(data = ModImps, exp = glmer(cbcl_withdep_y3 ~ pt_f + age_y3 + race_y0 
                            + (1|site_id_y1) + (1|rel_family_id),
                            control = glmerControl(optCtrl=list(maxfun=1e6), optimizer ='bobyqa'), family = 'poisson'))

resMIfitBase <-summary(pool(MIfitBase))
resMIfitBase

#Full model
MIfitFull <- with(data = ModImps, exp = glmer(cbcl_withdep_y3 ~ pt_f + age_y3 + race_y0 + household_income_y0 + parent_dep_y2
                            + (1|site_id_y1) + (1|rel_family_id),
                            control = glmerControl(optCtrl=list(maxfun=1e6), optimizer ='bobyqa'),
                            family = 'poisson',
                            weights = acs_raked_propensity_score_y0))

resMIfitFull <- summary(pool(MIfitFull))
resMIfitFull

#difficulty exporting mice output into tab_model so pasting model summary below 

#Basic 
# term    estimate  std.error  statistic       df      p.value
# 1      (Intercept)  0.02365080 0.02860744  0.8267361 2482.917 4.084661e-01
# 2             pt_f  0.16992299 0.02071613  8.2024506 2498.398 4.440892e-16
# 3           age_y3  0.05922825 0.02041596  2.9010758 2483.784 3.751544e-03
# 4     race_y0Black -0.25042609 0.07139221 -3.5077511 2473.958 4.599676e-04
# 5     race_y0Asian -0.14484718 0.13493746 -1.0734394 2315.850 2.831858e-01
# 6 race_y0AIAN/NHPI  0.02347283 0.23278019  0.1008369 2519.219 9.196880e-01
# 7     race_y0Other  0.19028989 0.11030412  1.7251385 2432.874 8.462950e-02
# 8     race_y0Mixed  0.13174167 0.06492925  2.0290033 2506.722 4.256344e-02

#glmer 

#               term    estimate  std.error  statistic       df      p.value
# 1      (Intercept) -0.19347256 0.04446141 -4.3514718 2492.549 1.406743e-05
# 2             pt_f  0.27285215 0.03103482  8.7918072 2497.416 0.000000e+00
# 3           age_y3  0.10629365 0.03048741  3.4864765 2482.444 4.979267e-04
# 4     race_y0Black -0.46305655 0.11526766 -4.0172287 2486.054 6.063420e-05
# 5     race_y0Asian -0.16246400 0.21351430 -0.7609046 2329.442 4.467911e-01
# 6 race_y0AIAN/NHPI -0.04628665 0.37083059 -0.1248189 2520.750 9.006769e-01
# 7     race_y0Other  0.21322339 0.16196684  1.3164632 2380.144 1.881454e-01
# 8     race_y0Mixed  0.18558497 0.09547172  1.9438738 2504.649 5.202253e-02



#Full 
#                term      estimate  std.error    statistic       df      p.value
# 1            (Intercept) -0.0932478065 0.15312683 -0.608957999 2490.999 5.426078e-01
# 2                   pt_f  0.1421822712 0.02073278  6.857847730 2460.270 8.809842e-12
# 3                 age_y3  0.0626324702 0.02039761  3.070578307 2432.809 2.160060e-03
# 4           race_y0Black -0.1829821449 0.07624179 -2.400024398 2460.299 1.646787e-02
# 5           race_y0Asian -0.0291577157 0.12335327 -0.236375701 2207.586 8.131631e-01
# 6       race_y0AIAN/NHPI -0.0001971227 0.19559085 -0.001007832 2504.154 9.991959e-01
# 7           race_y0Other  0.2197200926 0.10796828  2.035042952 2429.748 4.195489e-02
# 8           race_y0Mixed  0.0302306026 0.07405087  0.408240991 2492.573 6.831318e-01
# 9   household_income_y02  0.0511836101 0.19660689  0.260334772 2482.475 7.946271e-01
# 10  household_income_y03  0.0169433920 0.19758978  0.085750345 2450.036 9.316719e-01
# 11  household_income_y04  0.1906693833 0.18189484  1.048239631 2423.910 2.946327e-01
# 12  household_income_y05  0.0958820645 0.16872759  0.568265489 2492.018 5.699059e-01
# 13  household_income_y06  0.2668413492 0.16305930  1.636468110 2476.249 1.018687e-01
# 14  household_income_y07  0.1464303937 0.15858832  0.923336540 2488.885 3.559214e-01
# 15  household_income_y08  0.0898458608 0.15990659  0.561864644 2485.086 5.742589e-01
# 16  household_income_y09  0.1140696513 0.15596058  0.731400518 2490.944 4.646033e-01
# 17 household_income_y010  0.0872639766 0.16488689  0.529235382 2491.646 5.966893e-01
# 18         parent_dep_y2  0.2927021699 0.02172556 13.472707568 2239.742 0.000000e+00
> 






```


#Plot H1

Make effect sizes 
```{r}

```


https://lmudge13.github.io/sample_code/mixed_effects.html

```{r, complete cases}

CC_res_tbl <- tab_model(CCfitBase, CCfitFull,
                  show.se = TRUE,
                  show.df = FALSE,
                  show.ci = FALSE,
                  digits = 3,
                  title = "Females — Main effect of pubertal timing and depression (complete cases)",
                  dv.labels = c("Base", "Full"),
                  string.se = "SE",
                  string.p = "P-Value"
)

#save results 



```

#EXPLORATORY ANALYSES

1. Use gonadal and adrenal pubertal timing measures as separate predictors 

##gonadal pubertal timing

```{r, gonadal timing}

#imputed dataset
#Base model
MIfitBase_gonad <- with(data = ModImps, exp = lmerTest::lmer(cbcl_withdep_y3 ~ gonad_pt_f + age_years + race_y0 
                            + (1|site_id_y1) + (1|rel_family_id),
                            control = lmerControl(optimizer ="bobyqa")))

resMIfitBase_gonad <-summary(pool(MIfitBase))
resMIfitBase_gonad

#Full model
MIfitFull_gonad <- with(data = ModImps, exp = lmerTest::lmer(cbcl_withdep_y3 ~ gonad_pt_f + age_years + race_y0 + household_income_y0 + parent_dep_y2
                            + (1|site_id_y1) + (1|rel_family_id),
                            control = lmerControl(optimizer ="bobyqa"),
                            weights = acs_raked_propensity_score_y0))

resMIfitFull_gonad <- summary(pool(MIfitFull))
resMIfitFull_gonad

#Complete cases

CCfitBase_explr <- lmerTest::lmer(cbcl_withdep_y3 ~ gonad_pt_f + adren_pt_f + age_years + race_y0 
                            + (1|site_id_y1) + (1|rel_family_id),
                            control = lmerControl(optimizer ="bobyqa"),
                            data = dataSub,
                            na.action = na.exclude,
                       )

CCfitBase_explr

CCfitFull_explr <- lmerTest::lmer(cbcl_withdep_y3 ~ gonad_pt_f + adren_pt_f  + age_years + race_y0 
                            + household_income_y0 + parent_dep_y2
                            + (1|site_id_y1) + (1|rel_family_id),
                            control = lmerControl(optimizer ="bobyqa"),
                            weights = acs_raked_propensity_score_y0,
                            data = dataSub,
                            na.action = na.exclude
                       )


resCCfitFull_explr <- summary(CCfitFull_explr)
resCCfitFull_explr



#show in table 

sjPlot::tab_model(CCfitBase_explr, CCfitFull_explr,
                  show.se = TRUE,
                  show.df = FALSE,
                  show.ci = FALSE,
                  digits = 3,
                  terms = c("gonad_pt_f", "adren_pt_f"),
                  title = "Main effect of gonadal and adrenal timing on youth depression",
                  pred.labels = c("Gonadal timing", "Adrenal timing"),
                  dv.labels = c("Base", "Full"),
                  string.se = "SE",
                  string.p = "P-Value")


```



2. Control for Youth depression at year 1

For this exploratory analysis, we will use the complete cases dataframe as we are using youth depression at year 1 as an auxillary variable to predict outcome (year 3 youth depression) 









##Export tidied dataframe 

```{r, export data}
setwd("/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/data")


saveRDS(dataSub, "data_main_analy.rds")
```

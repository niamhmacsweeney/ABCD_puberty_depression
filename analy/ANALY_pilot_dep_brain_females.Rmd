---
title: "ANALY_pilot_dep_brain_females"
author: "Niamh MacSweeney"  Credit to X. Shen for function templates. 
date: "05/04/2022"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

\#ABCD Pilot Analysis Script - Depression \~ Brain Structure -\> Females

\#Introduction

The purpose of this script is to run the pilot analysis (DR\~BS) for the Puberty RR using the baseline data from data release 4.0. For this analysis, we will be using a random sub-sample of 10% (N= \~1,000) to generate ROIs for the depression \~ brain structure association.

This sub-sample will be split into males and females and the script will be run independently for each.

We will be using an related sample of participants for our analysis. The pilot analysis will use a basic model, outlined below.

<!-- Please note that in this script, brain structure is set as the dependent variable due to the treatment of hemisphere mixed effects. However, in the RR, our hypotheses state that depression is the dependent or outcome variable. As this analysis is cross-sectional, the Y and X terms are statistically interchangeable so Y \~ X = depression \~ brain = brain \~ depression. For our later mediation models, the order of the terms is important so depression will be the dependent or outcome variable. See RR manuscript for further details on mediation model set up. -->

Required Inputs

Cleaned data Rds files are located in /Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/data

Dependent Variable: CBCL Withdrawn-Depressed (Parent report): CBCL_dep_baseline_cleaned_R4.0.rds

Independent Variable Brain structure: cortical_baseline_R4.0.rds + subcort_baseline_R4.O.rds + dti_baseline_R4.0.rds

Covariates Covariates: covs_pilot_R4.0.rds

------------------------------------------------------------------------

####Workflow

1.  Setup: Load data, merge to create master dataframe, keep unrelated participants only
2.  Pilot prep: Get subsample of 10% of unrelated sample (N= 9,775). Split into males and females.
3.  Set up glm/lme function using Shen's template script

#####STEP 1: SETUP Load libraries and set wd

```{r, load libraries, set wd}


library(tidyr)
library(plyr) #load before dplyr
library(dplyr)
library(nlme)
library(lme4)
library(tidyverse)
library(psych)
library(ggplot2)
library(readr)
library(pbapply)
library(gridExtra)
library(sandwich)
library(stringr)
library(kableExtra)
#library(epiDisplay)
library(gmodels)



setwd("/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/analy")
```

Load data:

Note: all covariate data is in the covariates data file, except for ICV, which can be found in the cortical and subcortical data files. 

```{r,load data}

#Depression data 
dep <-rio::import("/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/data/CBCL_dep_baseline_R4.0.rds")

#Imaging data
cortical <-rio::import("/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/data/cortical_baseline_R4.0.rds")

subcort <-rio::import("/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/data/subcort_baseline_R4.0.rds")

dti <- rio::import("/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/data/dti_baseline_R4.0.rds")

#Covariates
covs <- rio::import("/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/data/covs_pilot_R4.0.rds")

```

Merge dataframes to create master dataframe

As we have a five data frames to merge, we are going to do it stepwise using dplyr function.

```{r, merge DFs}

df <- dep %>% 
  left_join(y=cortical, by= "src_subject_id") %>% 
  left_join(y=subcort, by= "src_subject_id") %>% 
  left_join(y=dti, by= "src_subject_id") %>% 
  left_join(y=covs, by="src_subject_id")

#check col names
colnames(df)

```

Check variable classifcation

```{r, variable classification}

 df %>% 
 select("race.6level", "age_years", "scanner_id", "rel_family_id") %>% 
  str()
```

### IGNORE CHUNK BELOW AS WE ARE USING THE RELATED SAMPLE FOR REVISED VERSION OF THE RR. 
Reduce to unrelated sample only Before N=11878, After N=9,856
We are going to randomise which family member is included in the study

```{r, get unrelated sample using randomisation approach}

#We are going to randomise which family member is included in the study 


#Assign random number to each family ID. Set random 

# df$random <- NA #generate new column of NAs
# unrel_df <- data.frame() #make new df

#iterate through family IDs using for loop (this will take a few minutes)


# # set.seed(2507) #to make sure random sample is the same random sample each time
# unique_fam_id <- unique(df$rel_family_id)
# for (i in unique_fam_id[1:length(unique_fam_id)]){
#   
#   set.seed(2507)
# 
#   
#   #subset each family and assign random number to each individual within each family
#   df$random[df$rel_family_id == i] <- sample(nrow(df[df$rel_family_id == i,]),nrow(df[df$rel_family_id == i,]), replace= FALSE)
#   
#   #select individual with highest number for unrelated dataframe
#   unrel_individual <- df[which.max(df$random[df$rel_family_id == i]),] 
# 
#   unrel_individual <- df[df$rel_family_id == i,][which.max(df$random[df$rel_family_id == i]),]
#     
# 
#   #append unrelated individual to unrelated dataframe
#   unrel_df <- rbind(unrel_df, unrel_individual)
#   
# }
# 
# nrow(unrel_df) #check that N= 9856
# 
# # i <- 8781 #for trouble shooting. 
# nrow(unrel_df) #check that N= 9856
# length(unique(unrel_df$rel_family_id)) #check that no. of unique IDs is correct. 
# 
# #Check that set.seed worked so that we get the same IDs each timescript is run
# 
# test_set_seed <- unrel_df$src_subject_id #make new vector of un_rel individual ids
# 
# #the rerun df$random lines + for loop, without clearing global environment
# #check if new participant id list matches test_set_seed
# 
# all(unrel_df$src_subject_id == test_set_seed) #it worked! 

```

Get sample demographics: Age = 9.90 years; SD = 0.62

```{r, sample demographics}

# # unrel_df %>% 
# #   dplyr::select(age_years, sex) %>% 
# #   summary()
# 
# #get sd
# sd(unrel_df$age_years)
# #get mean
# mean(unrel_df$age_years)
# 
# 
# 
# #make df with unrelated females only for demographic table purposes
# female_df <- df %>% #N= 5680
#     filter(sex == "F")
  

```

#####STEP 2: Generate subsample (10% of unrelated sample) for pilot analysis. N=986 Get females only

```{r, generate subsample, get females only}

set.seed(2507) #set seed for reproducibility
targetdata <- df %>% 
  sample_frac(size = 0.1, replace = FALSE)

#check males and females breakdown F= 564, M=624
targetdata %>% 
  dplyr::count(sex)

#get mean age and sd for pilot sample
mean(targetdata$age_years)
sd(targetdata$age_years)

#Get Female sample only 
targetdata <- targetdata %>% 
  filter(sex == "F")

```

####IGNORE: Make demographics table for MDD/DS breakdown

```{r, MDD/DS demographics table}

####TOTAL FEMALE UNRELATED SAMPLE

#no longer using MDD binary measure in this project due to error in MDD algorithm spotted in 4.0 release notes.

# #MDD case control
# CrossTable(unrel_females$KSADS.MDD.p, 
#            prop.t = TRUE, prop.r = TRUE, prop.c = TRUE)
# 
# #MDD and age breakdown
# ddply(unrel_females,~KSADS.MDD.p,summarise,mean=mean(age_years),sd=sd(age_years))

# #DS category breakdown
# CrossTable(unrel_females$KSADS.Depressive_symptoms_ever.p, 
#            prop.t = TRUE, prop.r = TRUE, prop.c = TRUE)
# 
# #DS and age breakdown
# ddply(unrel_females,~KSADS.Depressive_symptoms_ever.p,summarise,mean=mean(age_years),sd=sd(age_years))

#### PILOT ANALYSIS SAMPLE
# #MDD case control
# CrossTable(targetdata$KSADS.MDD.p, 
#            prop.t = TRUE, prop.r = TRUE, prop.c = TRUE)

#MDD and age breakdown
# ddply(targetdata,~KSADS.MDD.p,summarise,mean=mean(age_years),sd=sd(age_years))

# #DS category breakdown
# CrossTable(targetdata$KSADS.Depressive_symptoms_ever.p, 
#            prop.t = TRUE, prop.r = TRUE, prop.c = TRUE)
# 
# #DS and age breakdown
# ddply(targetdata,~KSADS.Depressive_symptoms_ever.p,summarise,mean=mean(age_years),sd=sd(age_years))


```

\#\#\#\#STEP 3: Model set up We are using X.Shen's phewasStyle_withCI.R function to run the linear models.

We need to change "src_subject_id" to "f.eid" so that function will run.

```{r, colnames}
colnames(targetdata)[1]='f.eid'
colnames(targetdata) #check it worked

```

Set categorical variables

```{r, set categorical variables}

targetdata$race.6level = as.factor(targetdata$race.6level)
targetdata$rel_family_id = as.factor(targetdata$rel_family_id)
targetdata$scanner_id = as.factor(targetdata$scanner_id)

```

Generate long-format data.

Note: for the lme models (bilaterlal brain regions only), the data needs to be in long-format (i.e, there is a row per hemisphere (lh and rh) for each participant. This is why the number of obs/rows doubles. In other words we are using a repeated measures design that looks at lh and rh independently and then combines them to generate a single association metric. [This is a very rough explanation to help facilitate understanding]

```{r, gen long-format data}
# colnames of imaging data
dat_colnames = colnames(targetdata)[grep('lh\\.|rh\\.',colnames(targetdata))] 

# colnames of non-imaging data/unilateral img data
cols_nonimg = colnames(targetdata)[!grepl('lh\\.|rh\\.',colnames(targetdata))]  
cols_nonimg = cols_nonimg[2:length(cols_nonimg)]

source('../functions/long_format_new.R')
targetdata_longformat <- long_format(targetdata,cols_nonimg,cols_img)

```

Define functions

```{r, Phewas function}

source('../functions/reg_phewasStyle_withCI.R')

```

Define global variables

```{r, global vars}
targetdata=targetdata
dat_long=targetdata_longformat

```

Set up dependent variables: Brain measures (this is actually the predictor in the model set up but the current function only works with Brain as the dependent and because all the data is from one timepoint (and therefore statistically interchangeable), we will leave the set up as is for the pilot analysis)

```{r, set up DVs}

ls.dep.fs.long=colnames(dat_long)[grep('sa\\.|thk\\.|vol\\.|sulc\\.|dtifa\\_|dtimd\\_|\\.ASEG\\.',colnames(dat_long))]
ls.dep.fs.short=colnames(targetdata)[grep('^bl\\.',colnames(targetdata))]
ls.dep.all=c(ls.dep.fs.long,ls.dep.fs.short)

ls.dep.all=ls.dep.all[c(grep('sa\\.|thk\\.|vol\\.|sulc\\.',ls.dep.all),
                        grep('\\.ASEG\\.',ls.dep.all),
                        grep('dtifa\\_',ls.dep.all),
                        grep('dtimd\\_',ls.dep.all))]
ls.dep.all=ls.dep.all[!duplicated(ls.dep.all)]

```

Set up Independent/Predictor Variables (or factors): Depression (Again, see above note, to avoid confusion, this is actually the outcome variable)

```{r, set up IVs}

ls.factor=colnames(targetdata)[grep('cbcl_scr_syn_withdep_r',
                                    colnames(targetdata))]

```

Combine DVs and IVs so that we get a list of the DV and IV

```{r, combine DVs and IVs}

ls.dep.factor.combo=expand.grid(ls.dep.all,ls.factor,stringsAsFactors = F)

```

Set up Covariates:

Fixed: age, race.6level, hemisphere (for bilateral), ICV (for individual region models), dmri_dti_meanmotion (for dti models)

Random: participant id nested within rel_family_id; scanner_id (not nested)

```{r, set up covs}

ls.models=data.frame(dependent=ls.dep.factor.combo$Var1,
                     factor=ls.dep.factor.combo$Var2,
                     covs='',stringsAsFactors = F)

ls.models$covs=paste0(c('age_years','race.6level','rel_family_id','scanner_id'),collapse='+')

#need to add in line here to differenitate random and fixed effect 

ls.models$covs[!grepl('bl\\.',ls.models$dependent)]=paste0(ls.models$covs[!grepl('bl\\.',ls.models$dependent)],'+hemi')

#need to adapt this to add in additional motion covariate for dti measures ls.models$covs[!grepl('bl\\.',ls.models$dependent)]=paste0(ls.models$covs[!grepl('bl\\.',ls.models$dependent)],'+hemi')


```

#### STEP 4: Specify models

Note: I think we can just use "lme" for everything

```{r, specify models}

ls.models$model.est=''
ls.models$model.est[grep('hemi',ls.models$covs)]='lme'
ls.models$model.est[ls.models$model.est=='']='glmer'


```

Divide models into bulk measures and individual regions

Bulk (global) measures

```{r, bulk measures}
ls.model.bulk=ls.models[grep('mean|total|allfibers',ls.models$dependent),]
ls.model.bulk$p_batch=1

```

Individual regions

```{r, individual regions}

ls.model.region=ls.models[!grepl('mean|total|allfibers',ls.models$dependent),]

ls.model.region$p_batch=99999
target.model=ls.model.region
ls.dep.cate=c('thk\\.','sa\\.','vol\\.APARC','sulc\\.','vol\\.ASEG','dtifa\\_','dtimd\\_')
ls.factor.cate=unique(target.model$factor)
cate.no = 1
for (fac in ls.factor.cate){
      for (dep in ls.dep.cate){
            loc = grepl(dep,target.model$dependent)&grepl(fac,target.model$factor)
            target.model$p_batch[loc]=cate.no
            cate.no=cate.no+1
      }
}
ls.model.region=target.model

# individual region models add intracranial volume as a covariate
ls.model.region.covWholeB=ls.model.region
ls.model.region.covWholeB$covs[grep('thk\\.|sa\\.|vol\\.APARC|sulc\\.|vol\\.ASEG',ls.model.region.covWholeB$dependent)]=
      paste0(ls.model.region.covWholeB$covs[grep('thk\\.|sa\\.|vol\\.APARC|sulc\\.|vol\\.ASEG',ls.model.region.covWholeB$dependent)],'+ICV')


```

#### STEP 5: Run Models

```{r, run models}
#troubleshooting function
# ls.models <- ls.model.bulk
# dat_short=targetdata
# dat_long=dat_long
# correctByFactor = TRUE

#Global (bulk) models
result.females.dep_brain.bulk=reg_phewasStyle(ls.model.bulk,dat_short=targetdata,dat_long=dat_long,correctByFactor = T)

#Regional (Individual) models
result.females.dep_brain.region.covWholeB=reg_phewasStyle(ls.model.region.covWholeB,dat_short=targetdata,dat_long=dat_long,correctByFactor = T)

#Save as R.Data file
save(result.females.dep_brain.bulk,result.females.dep_brain.region.covWholeB,file='../results/females_dep_brain_pilot_analysis.RData')

#add TRUE column if nominal p value < 0.05 for pilot ROIs

#global results
result.females.dep_brain.bulk$Sig <- as.numeric((as.character(result.females.dep_brain.bulk[,"p.value"]))) < 0.05

#regional results
result.females.dep_brain.region.covWholeB$Sig <- as.numeric((as.character(result.females.dep_brain.region.covWholeB[,"p.value"]))) < 0.05

#Save results as .csv files

#global results
write.csv(result.females.dep_brain.bulk, file = "../results/tables/pilot_analy_females.dep_brain.bulk.csv")

#regional results 
write.csv(result.females.dep_brain.region.covWholeB, file = "../results/tables/pilot_analy_females.dep_brain.regional.csv")

```

STEP 6: Identify ROIs for confirmatory analysis. Threshold: Nominal p-value \< 0.05

```{r, make tables}

ROI_dep_brain_females_regional_results <- result.females.dep_brain.region.covWholeB %>% 
  filter(p.value <0.05)


  # filter(p.value <0.05) %>% 
  # select(-dependent, -factor) %>% 
  # #mutate(as.numeric(ROI_females_regional)) %>% 
  # #mutate_if(is.numeric, ~round(., 4)) %>% 
  # arrange(p.value)

#save as R.data
save(ROI_dep_brain_females_regional_results,file='../results/ROIs_dep_brain_females_pilot_analysis.RData')

#save as .csv
write.csv(ROI_dep_brain_females_regional_results, file = "../results/tables/ROIs_dep_brain_females.csv")

#save as Kable Table 

ROI_table <- ROI_dep_brain_females_regional_results %>%
       kable(digits=4, format = "html",
      caption = "Females: Depressive symptoms-brain structure models and associated statistics with significant ROI associations") %>%
               kable_styling(font_size = 15,
                             position = "left",
                             full_width = F) #%>%
      #save_kable(file = "../figs/female_ROIs_PT_brain_pilot_analysis.png")

str(ROI_dep_brain_females_regional_results) #check variable chars


```

# \#\#\#\#\#\#\#\#\#\#\#\#\#\# End of Script \#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#

Make demographic table for paper - where we have a breakdown of the MDD and DS categories for each sex

```{r, demographic table}


```

---
title: "PREP_CBCL_R4.0"
Date: 16/03/22
Author: Niamh MacSweeney
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Introduction

The purpose of this script is to generate depression severity measure (DSM5 scale, continuous measure) from the Child Behaviour Checklist (CBCL) using ABCD Release 4.0 to prepare a final, clean, sample for use in models for MacSweeney et al.'s Puberty RR.

We will create the following dataframes:

1.  CBCL_dep_y0 at baseline (we will use this in the pilot data analysis)
2.  CBCL_dep_y1 at Year 1 (will need to remove those with depression at Year 1 from the main analysis due to our hypothesed mediation)
3.  CBCL_dep_y3 at Year 3 (this data will be used as the primary outcome in the main analysis)

###Script workflow:

1.  Setup: load data, tidy, get sample sizes for each timepoint/wave.
2.  Step 1: Inspect data.

###Resources:

-   Please consult this guide for an overview of the DSM scales: <https://aseba.org/wp-content/uploads/DSM-Oriented-Guide-for-the-ASEBA.pdf>

A note on T-scores from the ASEBA guide:

"Normalized T scores are standard scores that are based on the percentiles occupied by raw scale scores in the distribution of scores obtained by individuals in the relevant normative sample. Consequently, the T score obtained by an individual tells us approximately how high (in terms of a percentile) the individual's scale score is, compared to the scores obtained by individuals in the relevant normative sample"

Because substantial percentages of individuals in the normative samples obtained very low scores on the DSM-oriented and syndrome scales (e.g., scores of 0 or 1), the T score assignments start at 50, which represents the 50th percentile of scores in a normative sample. In other words, all raw scale scores that were in the lowest 50 percent of the distribution are assigned a T score of 50.

However, for statistical analyses, raw scale scores are often preferable, because they reflect all the variation that actually occurs in scores obtained by the individuals whose data are being analyzed. T scores, by contrast, lump together some raw scale scores, such as the different low scores that are given a T score of 50"

###SETUP Load libraries needed and set working directory

```{r, libraries}

library(tidyr)
library(dplyr)
library(tidyverse)
library(psych)
library(ggplot2)
library(ggstatsplot)
library(GGally)
library(stringr)
library(outliers)
library(jtools) 
library(readr)
library(gridExtra)
library(cowplot)
library(ggpubr)

setwd("/Volumes/GenScotDepression/users/niamh/puberty_ABCD/ABCD_puberty_depression/prep")
getwd()

```

LOAD DATA, REDUCE VARIABLES, CREATE DATAFRAME

Variables of interest: short names (as per NDA data dictionary)

-   DSM-5 depression scale (raw score): cbcl_scr_dsm5_depress_r (outcome of interest)
-   Withdrawn Depressed Syndrome Scale: cbcl_scr_syn_withdep_r (look at correlation with DSM score)

```{r, load data and tidy}
cbcl <-rio::import("/Volumes/GenScotDepression/data/abcd/release4.0/iii.data/Mental_Health/abcd_cbcls01.rds")

head(cbcl, n=10) #first few observations
str(cbcl)  #types of variables
names(cbcl) #List variables in dataframe

#Check how sample sizes for each wave of imaging data. 
CBCL_sample_siz_tbl <- cbcl %>%
  group_by(eventname) %>% 
  summarise(no_rows = length(eventname))
print(CBCL_sample_siz_tbl)

#extract all variables containing "dep" for depression variables

cbcl_dep <- cbcl %>% 
  select(src_subject_id, interview_date, interview_age, sex, eventname, contains("dep"))

colnames(cbcl_dep) #check correct columns have been extracted
str(cbcl_dep) #check variable types -- change intg. values to numeric for plotting purposes

cbcl$cbcl_scr_dsm5_depress_r <- as.numeric(cbcl$cbcl_scr_dsm5_depress_r)
cbcl$cbcl_scr_syn_withdep_r <- as.numeric(cbcl$cbcl_scr_syn_withdep_r)
 
summary(cbcl$cbcl_scr_dsm5_depress_r) #get summary
summary(cbcl$cbcl_scr_syn_withdep_r) 


```

Let's plot depression measures to look at distribution

Looking at the graphs, it seems there are a lot of "0" values in each timepoint. For count data like this, we will need to use poisson regression in our analysis models (or negative binomial regression or zero-inflated regression if the poisson regression models are "over dispersed").
```{r, plot distribution, fig.show="hold", out.width="50%}

### DSM Depression ####
dsm_dep_plot <- cbcl_dep %>% 
  ggplot(aes(x = cbcl_scr_dsm5_depress_r)) +
  geom_histogram(bins = 15,
                colour = "skyblue4",
                 fill = "skyblue3") +
  facet_grid(eventname ~ ., scales = "free") + #this will show dist for all waves
  labs(title = "CBCL DSM-5 Depression", x = "CBCL_DSM5_Depression (raw score)") +
  scale_x_continuous(breaks=seq(0, 20, 3), limits = c(0,20))
print(dsm_dep_plot) #distributions all look v similar

#### Withdrawn Depressed  ####

with_dep_plot <- cbcl_dep %>% 
  ggplot(aes(x = cbcl_scr_syn_withdep_r)) +
  geom_histogram(bins = 15,
                colour = "darkorange4",
                 fill = "darkorange3") +
  facet_grid(eventname ~ ., scales = "free") + #show dist for each timepoint separately
  labs(title = "CBCL Withdrawn Depressed Syndrome ", x = "CBCL_with_Depress (raw score)") +
  scale_x_continuous(breaks=seq(0, 20, 3), limits = c(0,20))
print(with_dep_plot) #distributions all look v similar


```

#### Correlation between two depression measures in CBCL

They are very highly correlated, as expected. r = 0.73
```{r, check correlation}

#define plot
cbcl_dep_corr <- ggplot(data = cbcl_dep,
                       mapping = aes(x = cbcl_scr_dsm5_depress_r , y = cbcl_scr_syn_withdep_r))

#plot
cbcl_dep_corr +
  geom_point(alpha = 0.7, size=2, color = "#00AFBB" ) +
  labs(title = "CBCL DSM Depression and CBCL Withdrawn-Depressed Relationship",
       y= "CBCL Withrawn-Depressed",
       x = "CBCL DSM Depression") +
  geom_smooth(method = "lm") +
  stat_cor(method = "pearson", label.x = 1.5, label.y =  25)

print(cbcl_dep_corr)

```

###Check correlation between Depression severity measure from KSADS (used in original draft of RR) for reviewer response letter. We need to use the CBCL measure since our outcome variable in the mediation analysis is at Year 3, and KSADS is not available at this time. 

```{r, check correlation between KSADS Dep Severity and CBCL DSM Depression}


```

For the purpose of this project, we want to exclude people with "clinically significant symptoms" at year 1
```{r, generate cut off score}



```

```{r, generate separate dataframes for each timepoint}

```


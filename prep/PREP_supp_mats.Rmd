---
title: "ABCD_pub_dep_supps"
author: "Niamh MacSweeney"
date: "7/7/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Scanning Protocols

\#\#Unrelated Participants

\#\#QC for Structural Brain Measures

For cortical measures, QC measures on raw imaging was first applied to remove poor-quality raw T1 scans (data field: 'iqc_t1_ok_ser'). Participants that had low post-processing quality check scores (\<1) for Freesurfer outcome identified (data field: 'fsqc_qc') were then removed.

For white matter microstructural measures, participants with poor-quality raw diffusion imaging scans (data field: 'iqc_dmri_ok_ser'), poor-quality raw T1 scans (data field: 'iqc_t1_ok_ser') and poor quality of FreeSurfer parcellation for T1 data (data field: 'fsqc_qc', potentially indicating low quality for T1 scans) were removed from further analyses.

The recommendations outlined by Hagler et al. 2019 did not include post-processing QC and previously analysis by Shen & MacSweeney et al. 2021, noted that removing individuals that did not pass post-processing QC (from 1.0 data release) did impact the results.

```{r setup, include=FALSE}

#### SETUP
#Load libraries needed and set working directory.

library(tidyverse)
library(dplyr)
library(broom)
library(ggplot2)


setwd("/Volumes/GenScotDepression/data/abcd/release2.0.1/iii.data/MRI_QC")

#STEP:1 LOAD DATA AND TIDY DATA
#Need satisfactory T1 raw images, Freesurfer (FS) and DTI QC, reduce to baseline data only.

qc.t1 <- readRDS("mriqcrp102.rds") %>% filter(eventname == "baseline_year_1_arm_1") #t1 image QC file, baseline only --- N=11871
qc.fs <- readRDS("freesqc01.rds")  %>% filter(eventname == "baseline_year_1_arm_1") #freesurfer QC file, baseline only --- N=11556
qc.criteria <- full_join(qc.t1,qc.fs) #merge two dataframes.

#select IDs that passed QC for T1 FS and DTI
#field name: iqc_t1_ok_ser = T1: Number of series that are complete and passed QC. Valid IDs: iqc_t1_ok_ser > 0
#field name: fsqc_qc = FS QC score. Valid IDs: fsqc_qc = 1
#field name: iqc_dmri_ok_ser = DTI: Number of series that are complete and passed QC. Valid IDs: iqc_dmri_ok_ser > 0

t1.ids.pass <- qc.criteria %>% 
  select(src_subject_id,iqc_t1_ok_ser,fsqc_qc) %>%  
  filter(iqc_t1_ok_ser >0) %>% # t1 raw scans that passed QC
  filter(fsqc_qc==1) # passed freesurfer QC
t1.ids.pass <- t1.ids.pass$src_subject_id # make new column for valid t1 IDs --- N =11,556

dti.ids.pass <- qc.criteria %>% 
  select(src_subject_id,iqc_dmri_ok_ser,iqc_t1_ok_ser,fsqc_qc) %>% 
  filter(iqc_dmri_ok_ser>0) %>% #DTI scans that passed QC
  filter(iqc_t1_ok_ser>0) %>% 
  filter(fsqc_qc==1) 
dti.ids.pass <- dti.ids.pass$src_subject_id #make new column 

```

As there were extreme values that caused the distributions of global white matter measures to be heavily skewed, we removed participants showing global FA and MD values 5 standard deviations from mean.

```{r setup, include=FALSE}

#### DTI/White matter Measures ####

#Tracts defined using Atlas Tract
#See Hagler et al. paper for further details on tract definition methods

#Using fractional anisotropy and mean diffusivity 

abcd_dti_p101 <- readRDS("abcd_dti_p101.rds")

abcd.dti<- abcd_dti_p101 %>% 
  filter(eventname == "baseline_year_1_arm_1") %>% #reduce to baseline --- N = 11,400
  .[,grep("subject|_dtifa_|_dtimd_", colnames(.))] %>% #select FA and MD cols
  .[,grep('subject|fiberat',colnames(.))]  #include DTI atlas tract adjustment


#tidyup column names
colnames(abcd.dti)=gsub('dmri_','',colnames(abcd.dti))
colnames(abcd.dti)=gsub('fiberat_','',colnames(abcd.dti))

colnames(abcd.dti)[grep('\\.all&rh$',colnames(abcd.dti))]=
  paste0('rhtotal.',gsub('\\.all|rh$','',colnames(IM.dat)))[grep('\\.all|rh$',colnames(IM.dat))]

#rearrange col names as done for cortical measures to make reading easier. 
colnames(abcd.dti)[grep('lh$',colnames(abcd.dti))]=paste0('lh.',gsub('lh$','',colnames(abcd.dti)))[grep('lh$',colnames(abcd.dti))]
colnames(abcd.dti)[grep('rh$',colnames(abcd.dti))]=paste0('rh.',gsub('rh$','',colnames(abcd.dti)))[grep('rh$',colnames(abcd.dti))]
colnames(abcd.dti)[grep('\\_all',colnames(abcd.dti))]=paste0('bl.',colnames(abcd.dti))[grep('\\_all',colnames(abcd.dti))]
colnames(abcd.dti)[grep('^dti',colnames(abcd.dti))]=paste0('bl.',colnames(abcd.dti))[grep('^dti',colnames(abcd.dti))]

#remove average FA and MD without corpus callosum
cols.omit <- abcd.dti %>% .[grep("_allfcc$|_allfib$",colnames(.))] 
abcd.dti <- abcd.dti[,!colnames(abcd.dti) %in% colnames(cols.omit)] #77 variables left.  

abcd.dti.final<- abcd.dti %>% 
  .[.$src_subject_id %in% dti.ids.pass,] #N= 10163

colnames(abcd.dti.final)


```

Distribution of DTI measures (FA and MD) before outlier extraction

```{r setup, include=TRUE}
dti.dist.incl.outl <- abcd.dti.final %>%
  select(ends_with("allfibers"))%>% 
  gather() %>% 
  ggplot(aes(as.numeric(value)))+
  facet_wrap(~ key, scales = "free") +
  geom_histogram(fill = "deepskyblue4",
                 bin = 30,
                 ) 

print(dti.dist.incl.outl)


```

Remove outliers (individuals exceeding Â±5SD from mean.

```{r setup, include=TRUE}


abcd.dti.final %>% #without outliers included
  select(ends_with("allfibers"))%>% 
  gather() %>% 
  ggplot(aes(as.numeric(value)))+
  facet_wrap(~ key, scales = "free") +
  geom_histogram(fill = "deepskyblue4",
                 bin = 30,
                 ) 

```
